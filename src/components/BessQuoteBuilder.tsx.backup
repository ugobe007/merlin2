import React, { useState, useEffect, useRef, Suspense } from 'react';
import { UTILITY_RATES } from '../utils/energyCalculations';
import { generateCalculationBreakdown, exportCalculationsToText } from '../utils/calculationFormulas';
import { authService } from '../services/authService';
import { calculateBESSPricing, PRICING_SOURCES, formatPricingForDisplay, calculateRealWorldPrice, calculateSystemCost } from '../utils/bessPricing';
import { calculateQuickEstimate, calculateComprehensiveSystemCosts, formatCurrency, type SystemConfiguration } from '../utils/calculationUtils';
import { generateBESSQuoteDocument, type QuoteData } from '../services/wordExportService';
import EditableUserProfile from './EditableUserProfile';
import Portfolio from './Portfolio';
import PublicProfileViewer from './PublicProfileViewer';
import AuthModal from './AuthModal';

// Lazy load modal components to improve initial bundle size
const JoinMerlinModal = React.lazy(() => import('./modals/JoinMerlinModal'));
const LayoutPreferenceModal = React.lazy(() => import('./modals/LayoutPreferenceModal'));
const CalculationModal = React.lazy(() => import('./modals/CalculationModal'));
const VendorManager = React.lazy(() => import('./VendorManager'));
const PricingPlans = React.lazy(() => import('./PricingPlans'));
const WelcomeModal = React.lazy(() => import('./modals/WelcomeModal'));
const AccountSetup = React.lazy(() => import('./modals/AccountSetup'));
const EnhancedProfile = React.lazy(() => import('./EnhancedProfile'));
const AdvancedAnalytics = React.lazy(() => import('./AdvancedAnalytics'));
const EnhancedBESSAnalytics = React.lazy(() => import('./EnhancedBESSAnalytics'));
const FinancingCalculator = React.lazy(() => import('./FinancingCalculator'));
const UseCaseTemplates = React.lazy(() => import('./UseCaseTemplates'));
const PricingDataCapture = React.lazy(() => import('./PricingDataCapture'));
const MarketIntelligenceDashboard = React.lazy(() => import('./MarketIntelligenceDashboard'));
const VendorSponsorship = React.lazy(() => import('./VendorSponsorship'));
const PrivacyPolicy = React.lazy(() => import('./PrivacyPolicy'));
const TermsOfService = React.lazy(() => import('./TermsOfService'));
const SecurityPrivacySettings = React.lazy(() => import('./SecurityPrivacySettings'));
const SystemHealth = React.lazy(() => import('./SystemHealth'));
const StatusPage = React.lazy(() => import('./StatusPage'));
const UtilityRatesManager = React.lazy(() => import('./UtilityRatesManager'));
const QuoteTemplates = React.lazy(() => import('./QuoteTemplates'));
const PricingPresets = React.lazy(() => import('./PricingPresets'));
const QuoteReviewWorkflow = React.lazy(() => import('./QuoteReviewWorkflow'));
const UseCaseROI = React.lazy(() => import('./UseCaseROI'));
import type { UseCaseData } from './UseCaseROI';
import type { ProfileData } from './modals/AccountSetup';
import type { UseCaseTemplate } from './UseCaseTemplates';
import merlinImage from "../assets/images/new_Merlin.png";
import merlinDancingVideo from "../assets/images/Merlin_video.mp4";
const SmartWizard = React.lazy(() => import('./wizard/SmartWizardV2'));
import magicPoofSound from "../assets/sounds/Magic_Poof.mp3";
const SaveProjectModal = React.lazy(() => import('./modals/SaveProjectModal'));
const LoadProjectModal = React.lazy(() => import('./modals/LoadProjectModal'));
const QuotePreviewModal = React.lazy(() => import('./modals/QuotePreviewModal'));
const AboutMerlin = React.lazy(() => import('./AboutMerlin'));
const VendorPortal = React.lazy(() => import('./VendorPortal'));
import EnergyNewsTicker from './EnergyNewsTicker';
import { useModalManager } from '../hooks/useModalManager';
import MainQuoteForm from './forms/MainQuoteForm';
import HeroSection from './hero/HeroSection';

// Loading component for lazy-loaded modals
const ModalLoader = () => (
  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div className="bg-white rounded-lg p-6 flex items-center gap-3">
      <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-purple-600"></div>
      <span className="text-gray-700">Loading...</span>
    </div>
  </div>
);


export default function BessQuoteBuilder() {
  const renderIdRef = useRef(Math.random().toString(36).substr(2, 9));
  
  // Centralized modal management
  const { modals, openModal, closeModal, isModalOpen } = useModalManager();
  
  // Check for public profile route
  const [viewMode, setViewMode] = useState<'app' | 'public-profile'>('app');
  const [publicProfileSlug, setPublicProfileSlug] = useState<string | null>(null);
  
  // Advanced layout preferences - declare early to avoid block-scoped issues
  const [showAdvancedQuoteBuilder, setShowAdvancedQuoteBuilder] = useState(() => {
    // Try to restore from localStorage to handle component re-mounts
    try {
      const saved = localStorage.getItem('showAdvancedQuoteBuilder');
      return saved === 'true';
    } catch {
      return false;
    }
  });
  const [userLayoutPreference, setUserLayoutPreference] = useState<'beginner' | 'advanced'>('beginner');
  const [showLayoutPreferenceModal, setShowLayoutPreferenceModal] = useState(false);
  
  // Advanced form state - Updated with industry-standard defaults
  const [energyCapacity, setEnergyCapacity] = useState(2); // 2 MWh for typical commercial peak shaving
  const [powerRating, setPowerRating] = useState(1); // 1 MW for typical commercial system
  const [showAdvancedOptions, setShowAdvancedOptions] = useState(false);

  // ALL OTHER STATE - moved to beginning to avoid hooks rule violations
  const [quoteName, setQuoteName] = useState('My BESS Project');
  const [isFirstTimeProfile, setIsFirstTimeProfile] = useState(false);
  const [isLoggedIn, setIsLoggedIn] = useState(false);

  // System Configuration State - ALL MOVED TO BEGINNING
  const [powerMW, setPowerMW] = useState(1);
  const [standbyHours, setStandbyHours] = useState(2);
  const [gridMode, setGridMode] = useState('On-grid');
  const [useCase, setUseCase] = useState('EV Charging Stations');
  const [generatorMW, setGeneratorMW] = useState(0);
  const [solarMWp, setSolarMWp] = useState(0);
  const [windMW, setWindMW] = useState(0);
  const [valueKwh, setValueKwh] = useState(0.25);
  const [utilization, setUtilization] = useState(0.3);
  const [warranty, setWarranty] = useState('10 years');
  const [location, setLocation] = useState('UK (6%)');
  const [selectedCountry, setSelectedCountry] = useState('United States');
  const [currency, setCurrency] = useState('USD');
  
  // New flexible sizing state - Updated to MW/MWh defaults for commercial scale
  const [energyUnit, setEnergyUnit] = useState('MWh');
  const [powerUnit, setPowerUnit] = useState('MW');
  const [applicationType, setApplicationType] = useState<'residential' | 'commercial' | 'utility' | 'ups'>('residential');
  
  // Assumptions State (default values) - VALIDATED AGAINST NREL ATB 2024
  // Source: https://atb.nrel.gov/electricity/2024/utility-scale_battery_storage
  // Uses NREL Moderate Scenario pricing for commercial/small utility scale
  const [batteryKwh, setBatteryKwh] = useState(140); // Small scale, between NREL Moderate (155) and Advanced (135)
  const [pcsKw, setPcsKw] = useState(150); // Industry standard PCS pricing
  const [bosPercent, setBosPercent] = useState(0.12); // NREL recommended BOS percentage
  const [epcPercent, setEpcPercent] = useState(0.15); // Industry standard EPC (NREL includes in total cost)
  const [offGridPcsFactor, setOffGridPcsFactor] = useState(1.25);
  const [onGridPcsFactor, setOnGridPcsFactor] = useState(1);
  const [genKw, setGenKw] = useState(300);
  const [solarKwp, setSolarKwp] = useState(0);
  const [windKw, setWindKw] = useState(1200);
  const [tariffPercent, setTariffPercent] = useState(0.10);

  // Non-modal state
  const [currentQuoteStatus, setCurrentQuoteStatus] = useState<'draft' | 'in-review' | 'approved' | 'rejected' | 'shared'>('draft');
  const [currentQuote, setCurrentQuote] = useState<any>(null);

  // If viewing a public profile, show that instead - check early but after all hooks
  if (viewMode === 'public-profile' && publicProfileSlug) {
    const handleNavigateToApp = () => {
      window.history.pushState({}, '', '/');
      setViewMode('app');
      openModal('showAuthModal');
    };
    return <PublicProfileViewer profileSlug={publicProfileSlug} onSignUp={handleNavigateToApp} />;
  }

  useEffect(() => {
    // Simple routing check - look for /profile/ in URL
    const path = window.location.pathname;
    if (path.startsWith('/profile/')) {
      const slug = path.split('/profile/')[1];
      setPublicProfileSlug(slug);
      setViewMode('public-profile');
    }
  }, []);

  const handleNavigateToApp = () => {
    window.history.pushState({}, '', '/');
    setViewMode('app');
    openModal('showAuthModal');
  };

  // Render main quote form for advanced interface
  const renderMainQuoteForm = () => (
    <MainQuoteForm
      energyCapacity={energyCapacity}
      setEnergyCapacity={setEnergyCapacity}
      energyUnit={energyUnit}
      setEnergyUnit={setEnergyUnit}
      powerRating={powerRating}
      setPowerRating={setPowerRating}
      powerUnit={powerUnit}
      setPowerUnit={setPowerUnit}
      applicationType={applicationType}
      setApplicationType={setApplicationType}
      showAdvancedOptions={showAdvancedOptions}
      setShowAdvancedOptions={setShowAdvancedOptions}
      openModal={openModal}
      handleSaveProject={handleSaveProject}
      quoteName={quoteName}
    />
  );

  // Wrapper to persist state
  const setShowAdvancedQuoteBuilderPersisted = (value: boolean) => {
    try {
      localStorage.setItem('showAdvancedQuoteBuilder', value.toString());
    } catch (error) {
    }
    setShowAdvancedQuoteBuilder(value);
  };

  // Effects and handlers go here
  useEffect(() => {
    setIsLoggedIn(authService.isAuthenticated());
    
    // Load user layout preference
    const user = authService.getCurrentUser();
    if (user && user.preferences?.layoutPreference) {
      setUserLayoutPreference(user.preferences.layoutPreference);
    }
  }, []);

  // Check if user needs to complete profile after login
  useEffect(() => {
    if (isLoggedIn) {
      const user = authService.getCurrentUser();
      if (user && !user.profileCompleted) {
        openModal('showWelcomeModal');
      }
    }
  }, [isLoggedIn]);

  // Debug: Track showAdvancedQuoteBuilder state changes
  useEffect(() => {
    if (showAdvancedQuoteBuilder) {
    } else {
      // Add stack trace to see what's causing the close
    }
  }, [showAdvancedQuoteBuilder]);

  // Debug: Track modal states
  useEffect(() => {
  }, [isModalOpen('showTemplates')]);

  useEffect(() => {
  }, [isModalOpen('showEnhancedAnalytics')]);

  useEffect(() => {
  }, [isModalOpen('showEnhancedBESSAnalytics')]);

  useEffect(() => {
  }, [isModalOpen('showFinancing')]);

  // Cleanup localStorage on unmount to prevent stale state
  useEffect(() => {
    return () => {
      try {
        localStorage.removeItem('showAdvancedQuoteBuilder');
      } catch (error) {
      }
    };
  }, []);

  const handleLoginSuccess = () => {
    setIsLoggedIn(true);
    const user = authService.getCurrentUser();
    if (user && !user.profileCompleted) {
      openModal('showWelcomeModal');
    }
  };

  const handleProfileSetup = () => {
    closeModal('showWelcomeModal');
    openModal('showAccountSetup');
  };

  const handleStartWizard = () => {
    closeModal('showWelcomeModal');
    openModal('showSmartWizard');
  };

  const handleGoHome = () => {
    closeModal('showWelcomeModal');
    // Mark profile as completed even if skipped
    const user = authService.getCurrentUser();
    if (user && !user.profileCompleted) {
      authService.updateUserProfile(user.id, { profileCompleted: true });
    }
  };

  const handleAdvancedQuoteBuilder = () => {
    
    setShowAdvancedQuoteBuilderPersisted(true);
  };

  const handleLayoutPreference = (preference: 'beginner' | 'advanced') => {
    setUserLayoutPreference(preference);
    setShowLayoutPreferenceModal(false);
    
    if (preference === 'advanced') {
      setShowAdvancedQuoteBuilderPersisted(true);
    } else {
      openModal('showAuthModal');
    }
  };

  const handleSaveLayoutPreference = (preference: 'beginner' | 'advanced') => {
    const user = authService.getCurrentUser();
    if (user) {
      authService.updateUserProfile(user.id, {
        preferences: {
          ...user.preferences,
          layoutPreference: preference
        }
      });
      setUserLayoutPreference(preference);
    }
  };

  const handleProfileComplete = (profileData: ProfileData) => {
    const user = authService.getCurrentUser();
    if (user) {
      authService.updateUserProfile(user.id, {
        jobTitle: profileData.jobTitle,
        company: profileData.companyName || user.company,
        preferences: profileData.preferences,
        profileCompleted: true,
      });
    }
  };

  const handleContinueToEnhancedProfile = () => {
    closeModal('showAccountSetup');
    setIsFirstTimeProfile(true);
    openModal('showEnhancedProfile');
  };

  const handleEnhancedProfileClose = () => {
    closeModal('showEnhancedProfile');
    setIsFirstTimeProfile(false);
  };
  
  // Exchange rates (relative to USD)
  const exchangeRates: { [key: string]: number } = {
    'USD': 1.0,
    'EUR': 0.92,
    'GBP': 0.79,
    'JPY': 149.50,
    'CNY': 7.24,
    'CAD': 1.36,
    'AUD': 1.53,
    'INR': 83.12,
    'BRL': 4.97,
    'MXN': 17.08,
    'KRW': 1337.50,
  };

  // Convert USD amount to selected currency
  const convertCurrency = (amountUSD: number): number => {
    return amountUSD * exchangeRates[currency];
  };

  const handleSaveProject = async () => {
    try {
      // Create project data object
      const projectData = {
        project_name: `${applicationType || 'BESS'} Project - ${new Date().toLocaleDateString()}`,
        timestamp: new Date().toISOString(),
        configuration: {
          applicationType,
          powerMW,
          standbyHours,
          selectedCountry,
          useCase,
          annualSavings,
          systemCost: systemCost.totalCost,
        }
      };

      // Save to localStorage
      const savedProjects = JSON.parse(localStorage.getItem('savedBessProjects') || '[]');
      savedProjects.push(projectData);
      localStorage.setItem('savedBessProjects', JSON.stringify(savedProjects));

      // Also download as JSON file
      const blob = new Blob([JSON.stringify(projectData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${projectData.project_name.replace(/[^a-zA-Z0-9]/g, '_')}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      alert(`‚úÖ Project saved successfully!\n\n‚Ä¢ Saved to browser storage\n‚Ä¢ Downloaded as JSON file\n\nProject: ${projectData.project_name}`);
    } catch (error) {
      alert('‚ùå Error saving project. Please try again.');
    }
  };

  const handleUploadProject = () => {
    // Create file input element to load JSON project file
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = (e: Event) => {
      const file = (e.target as HTMLInputElement).files?.[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const data = JSON.parse(event.target?.result as string);
          // Load the project data
          loadProjectData(data);
          alert(`‚úÖ Project "${data.project_name || 'Unnamed'}" uploaded successfully!`);
        } catch (error) {
          alert('‚ùå Error loading project file. Please check the file format.');
        }
      };
      reader.readAsText(file);
    };
    input.click();
  };

  const handleCreateWithWizard = () => {
    openModal('showSmartWizard');
  };

  const handleSaveToPortfolio = async () => {
    if (!isLoggedIn) {
      openModal('showAuthModal');
      return;
    }

    const token = localStorage.getItem('auth_token');
    if (!token) {
      alert('Please sign in to save projects');
      return;
    }

    // Create quote object with all current values
    const quote = {
      id: Date.now().toString(),
      user_id: token,
      project_name: quoteName,
      inputs: {
        powerMW,
        standbyHours,
        gridMode,
        useCase,
        generatorMW,
        solarMWp,
        windMW,
        valueKwh,
        utilization,
        warranty,
        location,
        currency
      },
      assumptions: {
        batteryKwh,
        pcsKw,
        bosPercent,
        epcPercent,
        offGridPcsFactor,
        onGridPcsFactor,
        genKw,
        solarKwp,
        windKw
      },
      outputs: {
        // Store calculated values for display in portfolio
        totalMWh: powerMW * standbyHours,
        bessCapEx: 0, // Will be recalculated when loaded
        gridMode,
        useCase
      },
      tags: useCase,
      notes: '',
      is_favorite: false,
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString()
    };

    // Load existing quotes
    const savedQuotes = localStorage.getItem('merlin_quotes');
    const allQuotes = savedQuotes ? JSON.parse(savedQuotes) : [];
    
    // Add new quote
    allQuotes.push(quote);
    
    // Save back to localStorage
    localStorage.setItem('merlin_quotes', JSON.stringify(allQuotes));
    
    alert(`‚úÖ Project "${quoteName}" saved successfully!`);
    
    // Trigger portfolio refresh event
    window.dispatchEvent(new Event('portfolio-refresh'));
  };

  const handleLoadProject = () => {
    openModal('showLoadProjectModal');
  };

  const handleUploadFromComputer = () => {
    // Create file input element to load JSON/CSV project file
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = (e: Event) => {
      const file = (e.target as HTMLInputElement).files?.[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const data = JSON.parse(event.target?.result as string);
          // Load the project data
          loadProjectData(data);
          
          // Ask if they want to save to cloud (requires login)
          if (!isLoggedIn) {
            const shouldLogin = confirm('Project loaded! Would you like to sign up/sign in to save it to the cloud?');
            if (shouldLogin) {
              openModal('showAuthModal');
            }
          }
        } catch (error) {
          alert('‚ùå Error loading project file. Please check the file format.');
        }
      };
      reader.readAsText(file);
    };
    input.click();
  };
  
  const loadProjectData = (data: any) => {
    // Load all project data
    setQuoteName(data.quoteName || 'My BESS Project');
    setPowerMW(data.powerMW || 1);
    setStandbyHours(data.standbyHours || 2);
    setGridMode(data.gridMode || 'On-grid');
    setUseCase(data.useCase || 'EV Charging Stations');
    setGeneratorMW(data.generatorMW || 0);
    setSolarMWp(data.solarMWp || 0);
    setWindMW(data.windMW || 0);
    setValueKwh(data.valueKwh || 0.25);
    setUtilization(data.utilization || 0.3);
    setWarranty(data.warranty || '10 years');
    setLocation(data.location || 'UK (6%)');
    setCurrency(data.currency || 'USD');
    setBatteryKwh(data.batteryKwh || 140);
    setPcsKw(data.pcsKw || 150);
    setBosPercent(data.bosPercent || 0.12);
    setEpcPercent(data.epcPercent || 0.15);
    setOffGridPcsFactor(data.offGridPcsFactor || 1.25);
    setOnGridPcsFactor(data.onGridPcsFactor || 1);
    setGenKw(data.genKw || 300);
    setSolarKwp(data.solarKwp || 0);
    setWindKw(data.windKw || 1200);
    
    alert(`‚úÖ Project "${data.quoteName || 'Unnamed'}" loaded successfully!`);
  };

  const handleUploadFromPortfolio = () => {
    openModal('showPortfolio');
  };

  const loadProjectFromStorage = (quote: any) => {
    const projectData = localStorage.getItem(`merlin_project_${quote.project_name}`);
    if (!projectData) {
      alert('‚ùå Project not found!');
      return;
    }
    
    const data = JSON.parse(projectData);
    setQuoteName(data.quoteName || quoteName);
    setPowerMW(data.powerMW || 1);
    setStandbyHours(data.standbyHours || 2);
    setGridMode(data.gridMode || 'On-grid');
    setUseCase(data.useCase || 'EV Charging Stations');
    setGeneratorMW(data.generatorMW || 0);
    setSolarMWp(data.solarMWp || 0);
    setWindMW(data.windMW || 0);
    setValueKwh(data.valueKwh || 0.25);
    setUtilization(data.utilization || 0.3);
    setWarranty(data.warranty || '10 years');
    setLocation(data.location || 'UK (6%)');
    setBatteryKwh(data.batteryKwh || 140);
    setPcsKw(data.pcsKw || 150);
    setBosPercent(data.bosPercent || 0.12);
    setEpcPercent(data.epcPercent || 0.15);
    setOffGridPcsFactor(data.offGridPcsFactor || 1.25);
    setOnGridPcsFactor(data.onGridPcsFactor || 1);
    setGenKw(data.genKw || 300);
    setSolarKwp(data.solarKwp || 0);
    setWindKw(data.windKw || 1200);
    
    alert(`‚úÖ Project "${quote.project_name}" loaded successfully!`);
    closeModal('showPortfolio');
  };

  const handlePortfolio = () => {
    if (isLoggedIn) {
      openModal('showPortfolio');
    } else {
      openModal('showAuthModal');
    }
  };

  const handleUserProfile = () => {
    if (isLoggedIn) {
      // If logged in, show the profile viewer (not edit mode)
      openModal('showEnhancedProfile');
    } else {
      // If not logged in, show auth modal for sign in / join
      openModal('showAuthModal');
    }
  };

  const handleResetToDefaults = () => {
    // Reset all values to initial defaults
    setBatteryKwh(140);
    setPcsKw(150);
    setSolarKwp(0);
    setWindKw(1200);
    setGenKw(300);
    setBosPercent(0.12);
    setEpcPercent(0.15);
    setOffGridPcsFactor(1.25);
    setOnGridPcsFactor(1.0);
    setTariffPercent(0.10);
    
    // Show confirmation
    alert(
      `üîÑ Values Reset to Industry Standards!\n\n` +
      `Battery: $140/kWh (Small Scale)\n` +
      `PCS: $150/kW (Standard)\n` +
      `Off-Grid PCS Factor: 1.25\n` +
      `On-Grid PCS Factor: 1.0\n` +
      `Solar: $1,000/kWp (Commercial)\n` +
      `Wind: $1,200/kW (Utility)\n` +
      `Generator: $300/kW (Diesel)\n` +
      `BoS: 12% (Industry Standard)\n` +
      `EPC: 15% (Industry Standard)\n` +
      `Tariffs: 10%\n\n` +
      `All pricing based on Q4 2025 market data`
    );
  };

  const handleExportCalculations = () => {
    try {
      const calculations = generateCalculationBreakdown(
        powerMW,
        standbyHours,
        solarMWp,
        windMW,
        generatorMW,
        batteryKwh,
        pcsKw,
        bosPercent,
        epcPercent,
        genKw,
        solarKwp,
        windKw,
        location
      );

      const textContent = exportCalculationsToText(calculations);
      const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
      saveAs(blob, `${quoteName}_Calculations_${new Date().toISOString().split('T')[0]}.txt`);
      
      alert('‚úÖ Calculation formulas exported successfully!\n\nThis file shows every formula, variable, and assumption used in your quote.');
    } catch (error) {
      alert('‚ùå Failed to export calculations. Please try again.');
    }
  };

  const handleApplyTemplate = (template: UseCaseTemplate) => {
    setPowerMW(template.configuration.powerMW);
    setStandbyHours(template.configuration.durationHours);
    setGridMode(template.configuration.gridMode);
    setGeneratorMW(template.configuration.generatorMW || 0);
    setSolarMWp(template.configuration.solarMW || 0);
    setWindMW(template.configuration.windMW || 0);
    setUtilization(template.configuration.utilization);
    setWarranty(template.configuration.warranty);
    closeModal('showTemplates');
  };

  const handleExportWord = async () => {
    
    // Play magical sound effect
    try {
      const audio = new Audio(magicPoofSound);
      audio.volume = 0.5;
    } catch (err) {
    }
    
    try {
      // Use utility function for calculations
      const quickCalc = calculateQuickEstimate(
        powerMW,
        standbyHours,
        batteryKwh,
        pcsKw,
        bosPercent,
        epcPercent,
        generatorMW,
        solarMWp,
        windMW,
        genKw,
        solarKwp,
        windKw
      );

      // Prepare quote data for Word export service
      const quoteData: QuoteData = {
        quoteName: quoteName,
        powerMW,
        totalMWh: quickCalc.totalMWh,
        actualDuration: quickCalc.totalMWh / powerMW,
        gridConnection: gridMode,
        useCase: useCase,
        location: location,
        batterySubtotal: quickCalc.batterySubtotal,
        pcsSubtotal: quickCalc.pcsSubtotal,
        bosAmount: quickCalc.bosAmount,
        epcAmount: quickCalc.epcAmount,
        bessCapEx: quickCalc.bessCapEx,
        generatorSubtotal: quickCalc.generatorSubtotal,
        solarSubtotal: quickCalc.solarSubtotal,
        windSubtotal: quickCalc.windSubtotal,
        batteryTariff: quickCalc.batteryTariff,
        otherTariff: quickCalc.otherTariff,
        totalTariffs: quickCalc.totalTariffs,
        grandCapEx: quickCalc.grandCapEx,
        annualSavings: quickCalc.annualSavings,
        roiYears: quickCalc.roiYears,
        generatorMW: generatorMW > 0 ? generatorMW : undefined,
        solarMWp: solarMWp > 0 ? solarMWp : undefined,
        windMW: windMW > 0 ? windMW : undefined,
        warranty: warranty,
        projectTimeframe: '12-18 months',
        primaryGoal: `${useCase} energy storage system for ${location}`
      };

      // Use Word export service
      await generateBESSQuoteDocument(quoteData);
      
      alert(`‚úÖ Professional BESS Quote generated successfully!\n\n"${quoteName}_BESS_Quote.docx"\n\nIncludes:\n‚Ä¢ Project Information\n‚Ä¢ Executive Summary\n‚Ä¢ Project Overview & Visualization\n‚Ä¢ Technical Specifications & Pricing\n‚Ä¢ Financial Analysis & ROI\n‚Ä¢ Implementation & Certifications\n‚Ä¢ Summary & Next Steps\n‚Ä¢ Appendix A: Calculation Formulas`);
    } catch (error) {
      alert(`‚ùå Word export failed. Please try again.\n\nError: ${error instanceof Error ? error.message : 'Unknown error'}`);
    }
  };

  };

  // CALCULATIONS - Using Utility Functions
  const systemConfig = {
    powerMW,
    standbyHours,
    selectedCountry,
    useCase: useCase.toLowerCase().replace(/\s+/g, '-'),
    gridMode,
    batteryKwh,
    pcsKw,
    bosPercent,
    epcPercent,
    solarMWp,
    solarKwp,
    windMW,
    windKw,
    generatorMW,
    genKw,
  };

  // Calculate comprehensive system costs
  const comprehensiveResults = calculateComprehensiveSystemCosts(systemConfig);
  
  // Extract key values for UI
  const totalMWh = comprehensiveResults.systemCapacity.totalMWh;
  const actualDuration = comprehensiveResults.systemCapacity.actualDuration;
  const batterySubtotal = comprehensiveResults.costBreakdown.batterySubtotal;
  const pcsSubtotal = comprehensiveResults.costBreakdown.pcsSubtotal;
  const bosAmount = comprehensiveResults.costBreakdown.bosAmount;
  const epcAmount = comprehensiveResults.costBreakdown.epcAmount;
  const bessCapEx = comprehensiveResults.costBreakdown.bessCapEx;
  const generatorSubtotal = comprehensiveResults.costBreakdown.generatorSubtotal;
  const solarSubtotal = comprehensiveResults.costBreakdown.solarSubtotal;
  const windSubtotal = comprehensiveResults.costBreakdown.windSubtotal;
  const totalTariffs = comprehensiveResults.costBreakdown.totalTariffs;
  const grandCapEx = comprehensiveResults.costBreakdown.grandCapEx;
  const annualSavings = comprehensiveResults.roiAnalysis.annualSavings;
  const roiYears = comprehensiveResults.roiAnalysis.roiYears;
  
  // Legacy UI variables still needed
  const pcsKW = powerMW * 1000; // Used in UI display

  const inputStyle = "w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-lg font-medium bg-blue-50";
  const labelStyle = "block text-base font-semibold text-gray-800 mb-2 tracking-wide";
  const cardStyle = "bg-gradient-to-b from-white via-blue-50 to-blue-100 border-2 border-blue-300 rounded-2xl p-8 shadow-xl relative overflow-hidden";

  // Currency symbol helper
  const getCurrencySymbol = () => {
    const symbols: { [key: string]: string } = {
      'USD': '$',
      'EUR': '‚Ç¨',
      'GBP': '¬£',
      'JPY': '¬•',
      'CNY': '¬•',
      'CAD': 'C$',
      'AUD': 'A$',
      'INR': '‚Çπ',
      'BRL': 'R$',
      'MXN': 'MX$',
      'KRW': '‚Ç©',
    };
    return symbols[currency] || '$';
  };

  // Show About page if active
  if (isModalOpen('showAbout')) {
    return (
      <div>
        <div className="bg-white shadow-sm border-b">
          <div className="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <button
              onClick={() => closeModal('showAbout')}
              className="text-purple-600 hover:text-purple-700 font-semibold flex items-center gap-2"
            >
              ‚Üê Back to Home
            </button>
            <button
              onClick={() => openModal('showJoinModal')}
              className="bg-gradient-to-r from-purple-600 to-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:shadow-lg transition-all"
            >
              ‚ú® Join Now
            </button>
          </div>
        </div>
        <AboutMerlin onStartWizard={() => {
          closeModal('showAbout');
          openModal('showSmartWizard');
        }} />
      </div>
    );
  }

  // Show Vendor Portal if active
  if (isModalOpen('showVendorPortal')) {
    return (
      <div>
        <div className="bg-white shadow-sm border-b">
          <div className="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <button
              onClick={() => closeModal('showVendorPortal')}
              className="text-purple-600 hover:text-purple-700 font-semibold flex items-center gap-2"
            >
              ‚Üê Back to Home
            </button>
            <button
              onClick={() => openModal('showJoinModal')}
              className="bg-gradient-to-r from-purple-600 to-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:shadow-lg transition-all"
            >
              ‚ú® Join Customer Platform
            </button>
          </div>
        </div>
        <VendorPortal />
      </div>
    );
  }

  // If showing advanced quote builder
  if (showAdvancedQuoteBuilder) {
    return (
      <div 
        className="min-h-screen bg-gradient-to-br from-gray-900 via-blue-900 to-purple-900"
        onClick={(e) => {
          // Prevent the container from closing the advanced builder
          e.stopPropagation();
        }}
      >
        {/* Advanced Header */}
        <div className="bg-gradient-to-r from-orange-600 to-red-600 text-white p-4 shadow-lg">
          <div className="max-w-7xl mx-auto flex justify-between items-center">
            <div className="flex items-center gap-4">
              <h1 className="text-2xl font-bold">‚ö° Advanced Quote Builder</h1>
              <span className="bg-white/20 px-3 py-1 rounded-full text-sm">Power User Mode</span>
            </div>
            <div className="flex items-center gap-4">
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  setShowAdvancedQuoteBuilderPersisted(false);
                  openModal('showSmartWizard');
                }}
                className="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition-colors"
              >
                üéØ Smart Wizard Option
              </button>
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  setShowAdvancedQuoteBuilderPersisted(false);
                }}
                className="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition-colors"
              >
                ‚Üê Back to Home
              </button>
            </div>
          </div>
        </div>

        {/* Advanced Quote Builder Content - Scrollable to main form */}
        <div className="max-w-7xl mx-auto p-6">
          <div className="bg-white rounded-2xl shadow-2xl overflow-hidden">
            {/* Quick Actions Header */}
            <div className="bg-gradient-to-r from-gray-100 to-gray-200 p-6 border-b">
              <div className="flex flex-wrap gap-4 items-center justify-between">
                <div className="flex items-center gap-4">
                  <h2 className="text-xl font-bold text-gray-800">Advanced Configuration</h2>
                  <div className="flex gap-2">
                    <span className="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm">AI Available</span>
                    <span className="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm">Full Control</span>
                  </div>
                </div>
                <div className="flex gap-3">
                  {/* Templates Button */}
                  <button 
                    onClick={() => openModal('showTemplates')}
                    className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2"
                  >
                    üìã Templates
                  </button>

                  {/* Advanced BESS Analytics Button */}
                  <button 
                    onClick={() => openModal('showEnhancedBESSAnalytics')}
                    className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2"
                  >
                    ‚ö° Advanced Analytics
                  </button>

                  {/* Financing Button */}
                  <button 
                    onClick={() => openModal('showFinancing')}
                    className="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2"
                  >
                    üí∞ Financing
                  </button>
                </div>
              </div>
            </div>

            {/* Scroll to main quote builder form */}
            <div className="h-screen overflow-y-auto">
              {/* Main form content will be rendered here */}
              {renderMainQuoteForm()}
            </div>
          </div>
        </div>

        {/* Modal Components for Advanced Quote Builder */}
        {/* Templates Modal */}
        {isModalOpen('showTemplates') && (
          <UseCaseTemplates 
            isOpen={isModalOpen('showTemplates')} 
            onClose={() => closeModal('showTemplates')} 
            onApplyTemplate={(template) => {
              // Apply the template configuration
              setPowerMW(template.configuration.powerMW);
              setStandbyHours(template.configuration.durationHours);
              closeModal('showTemplates');
            }}
          />
        )}

        {/* Financing Calculator Modal */}
        {isModalOpen('showFinancing') && (
          <FinancingCalculator 
            isOpen={isModalOpen('showFinancing')} 
            onClose={() => closeModal('showFinancing')} 
            projectData={{
              quoteName: `${applicationType || 'BESS'} Project`,
              totalCapEx: systemCost.totalCost,
              annualSavings: annualSavings || 0,
              powerMW: powerMW,
              durationHours: standbyHours,
            }}
          />
        )}

        {/* Chat Modal - Functional Demo */}
        {isModalOpen('showChatModal') && (
          <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
              <div className="sticky top-0 bg-gradient-to-r from-green-500 to-emerald-600 text-white p-6 rounded-t-2xl">
                <div className="flex justify-between items-center">
                  <h2 className="text-3xl font-bold">üí¨ BESS AI Assistant</h2>
                  <button 
                    onClick={() => closeModal('showChatModal')}
                    className="text-white hover:text-gray-200 text-3xl font-bold"
                  >√ó</button>
                </div>
              </div>
              <div className="flex-1 flex flex-col">
                <div className="flex-1 p-6 overflow-y-auto bg-gray-50">
                  <div className="space-y-4">
                    <div className="flex items-start gap-3">
                      <div className="w-8 h-8 bg-gradient-to-br from-green-500 to-emerald-600 rounded-full flex items-center justify-center text-white font-bold">AI</div>
                      <div className="bg-white p-4 rounded-lg shadow-sm flex-1">
                        <p className="text-gray-800">Hi! I'm your BESS AI assistant. I can help you with:</p>
                        <ul className="mt-2 space-y-1 text-gray-700">
                          <li>‚Ä¢ System sizing and configuration</li>
                          <li>‚Ä¢ Financial analysis and ROI calculations</li>
                          <li>‚Ä¢ Battery technology comparisons</li>
                          <li>‚Ä¢ Grid services and revenue opportunities</li>
                          <li>‚Ä¢ Regulatory requirements and incentives</li>
                        </ul>
                        <p className="mt-3 text-gray-800">What would you like to know about your {applicationType || 'BESS'} project?</p>
                      </div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                      <button className="text-left p-3 bg-white rounded-lg border border-gray-200 hover:bg-green-50 hover:border-green-300 transition-colors">
                        <div className="font-semibold text-green-700">ÔøΩ Financial Analysis</div>
                        <div className="text-sm text-gray-600">ROI, payback, and revenue streams</div>
                      </button>
                      <button className="text-left p-3 bg-white rounded-lg border border-gray-200 hover:bg-blue-50 hover:border-blue-300 transition-colors">
                        <div className="font-semibold text-blue-700">‚ö° System Sizing</div>
                        <div className="text-sm text-gray-600">Optimal power and energy capacity</div>
                      </button>
                      <button className="text-left p-3 bg-white rounded-lg border border-gray-200 hover:bg-purple-50 hover:border-purple-300 transition-colors">
                        <div className="font-semibold text-purple-700">ÔøΩ Battery Technology</div>
                        <div className="text-sm text-gray-600">Chemistry comparison and selection</div>
                      </button>
                      <button className="text-left p-3 bg-white rounded-lg border border-gray-200 hover:bg-amber-50 hover:border-amber-300 transition-colors">
                        <div className="font-semibold text-amber-700">üìä Grid Services</div>
                        <div className="text-sm text-gray-600">Revenue opportunities and contracts</div>
                      </button>
                    </div>
                  </div>
                </div>
                <div className="p-4 border-t border-gray-200 bg-white">
                  <div className="flex gap-3">
                    <input 
                      type="text" 
                      placeholder="Ask me anything about battery energy storage..."
                      className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none"
                    />
                    <button className="px-6 py-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg hover:from-green-600 hover:to-emerald-700 transition-colors font-semibold">
                      Send
                    </button>
                  </div>
                  <p className="text-xs text-gray-500 mt-2">üí° This is a demo interface. Full AI chat functionality coming soon!</p>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Modal Renders for Advanced Configuration */}
        {/* ML Analytics Suite - EnhancedBESSAnalytics Component */}
        {isModalOpen('showEnhancedAnalytics') && (() => {
          try {
            return (
              <EnhancedBESSAnalytics
                isOpen={isModalOpen('showEnhancedAnalytics')}
                onClose={() => {
                  closeModal('showEnhancedAnalytics');
                }}
                projectData={{
                  quoteName,
                  storageSizeMW: powerMW,
                  durationHours: actualDuration,
                  useCase,
                  location: selectedCountry,
                }}
              />
            );
          } catch (error) {
            return <div>Error loading ML Analytics</div>;
          }
        })()}

        {/* Advanced BESS Analytics Modal - Financial Analytics */}
        {isModalOpen('showEnhancedBESSAnalytics') && (() => {
          return (
            <AdvancedAnalytics 
              isOpen={isModalOpen('showEnhancedBESSAnalytics')}
              onClose={() => {
                closeModal('showEnhancedBESSAnalytics');
              }}
              projectData={{
                quoteName: `${applicationType || 'BESS'} Project`,
                powerMW: powerMW,
                durationHours: standbyHours,
                totalCapEx: grandCapEx,
                annualSavings: annualSavings,
                batteryLifeYears: 15,
                discountRate: 0.08,
              }}
            />
          );
        })()}

        {/* Use Case Templates Modal */}
        {isModalOpen('showTemplates') && (
          <UseCaseTemplates
            isOpen={isModalOpen('showTemplates')}
            onClose={() => closeModal('showTemplates')}
            onApplyTemplate={handleApplyTemplate}
          />
        )}

        {/* Financing Calculator Modal */}
        {isModalOpen('showFinancing') && (
          <FinancingCalculator
            isOpen={isModalOpen('showFinancing')}
            onClose={() => closeModal('showFinancing')}
            projectData={{
              quoteName,
              totalCapEx: grandCapEx,
              annualSavings,
              powerMW,
              durationHours: standbyHours,
            }}
          />
        )}
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 via-white to-purple-50">
      
      <main className="p-8">
        {/* Energy News Ticker - Matches hero width */}
        <div className="my-6">
          <EnergyNewsTicker />
        </div>
        
        {/* Hero Section Component */}
        <HeroSection 
          openModal={openModal}
          setShowAdvancedQuoteBuilderPersisted={setShowAdvancedQuoteBuilderPersisted}
          selectedCountry={selectedCountry}
          bosPercent={bosPercent}
          epcPercent={epcPercent}
          pcsKw={pcsKw}
          currentQuote={currentQuote}
          isModalOpen={isModalOpen}
          closeModal={closeModal}
        />

        {/* Advanced Quote Builder Toggle - Show only when not already shown */}
        {!showAdvancedQuoteBuilder && (
          <section className="my-6">
            <div className="flex flex-col lg:flex-row items-center justify-center gap-4">
              {/* Advanced Quote Builder Button */}
              <button
                onClick={() => setShowAdvancedQuoteBuilderPersisted(true)}
                className="bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white px-12 py-6 rounded-2xl font-bold text-xl shadow-2xl transition-all inline-flex items-center gap-4"
              >
                <span className="text-3xl">üéØ</span>
                <div className="text-left">
                  <div>Advanced Quote Builder</div>
                  <div className="text-sm font-normal opacity-90">Customize every detail of your system</div>
                </div>
              </button>

              {/* Vendor & Contact Buttons */}
              <div className="flex gap-3">
                <button 
                  className="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-6 py-4 rounded-xl font-semibold shadow-lg transition-all inline-flex items-center gap-2"
                  onClick={() => openModal('showVendorPortal')}
                >
                  <span className="text-xl">üè¢</span>
                  <div className="text-left">
                    <div className="text-sm">Vendor Portal</div>
                    <div className="text-xs opacity-90">For suppliers & partners</div>
                  </div>
                </button>
                <a 
                  href="mailto:info@merlinenergy.com"
                  className="bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white px-6 py-4 rounded-xl font-semibold shadow-lg transition-all inline-flex items-center gap-2"
                >
                  <span className="text-xl">üìß</span>
                  <div className="text-left">
                    <div className="text-sm">Contact Us</div>
                    <div className="text-xs opacity-90">Get in touch</div>
                  </div>
                </a>
              </div>
            </div>
            <p className="text-sm text-gray-500 mt-3 text-center">For technical users who want full control over pricing and configuration</p>
          </section>
        )}

        {/* Technical Quote Building Sections - Only shown in Advanced Mode */}
        {showAdvancedQuoteBuilder && (
          <>
            {/* Back to Simple View Button */}
            <section className="my-6 text-center">
              <button
                onClick={() => setShowAdvancedQuoteBuilderPersisted(false)}
                className="bg-gray-200 hover:bg-gray-300 text-gray-800 px-8 py-3 rounded-xl font-semibold shadow-md transition-all inline-flex items-center gap-2"
              >
                <span>‚Üê</span>
                <span>Back to Simple View</span>
              </button>
            </section>

            {/* Project Management Section - Only in Advanced Mode */}
            <section className="my-6 rounded-2xl p-6 shadow-xl border-2 border-blue-400 bg-gradient-to-r from-blue-50 to-indigo-50">
              <h3 className="text-xl font-bold text-gray-800 mb-4 text-center">Project Management</h3>
              <div className="flex justify-center items-center space-x-4">
                <input 
                  type="text" 
                  placeholder="My BESS Project"
                  value={quoteName}
                  onChange={(e) => setQuoteName(e.target.value)}
                  className={`${inputStyle} w-64 text-center`}
                />
                
                <button 
                  className="bg-gradient-to-b from-gray-200 to-gray-300 text-gray-700 px-6 py-3 rounded-xl font-bold shadow-lg border-2 border-blue-400 flex items-center justify-center space-x-2"
                  onClick={handleSaveProject}
                >
                  <span className="text-xl">üíæ</span>
                  <span>Save</span>
                </button>
                
                <button 
                  className="bg-gradient-to-b from-green-400 to-green-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg border-2 border-green-800 flex items-center justify-center space-x-2"
                  onClick={handleLoadProject}
                >
                  <span className="text-xl">üìÇ</span>
                  <span>Load</span>
                </button>
                
                <button 
                  className="bg-gradient-to-b from-purple-600 to-purple-800 text-yellow-300 px-6 py-3 rounded-xl font-bold shadow-lg border-2 border-purple-900 flex items-center justify-center space-x-2"
                  onClick={handlePortfolio}
                >
                  <span>üìä</span>
                  <span>Portfolio</span>
                </button>
              </div>
            </section>

            {/* Main Quote Form */}
            {renderMainQuoteForm()}

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          {/* LEFT AND MIDDLE COLUMNS */}
          <div className="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-8">
            {/* SYSTEM CONFIGURATION PANEL */}
            <section className="rounded-2xl p-8 shadow-2xl border-2 border-purple-300 bg-gradient-to-b from-purple-50 via-purple-100 to-white relative overflow-hidden">
              <h2 className="text-3xl font-bold text-gray-800 mb-8">System Configuration</h2>
              <div className="space-y-6">
                <div>
                  <label className={labelStyle}>Power (MW)</label>
                  <input type="number" step="0.1" value={powerMW} onChange={(e) => setPowerMW(parseFloat(e.target.value) || 0)} className={inputStyle} />
                </div>
                <div>
                  <label className={labelStyle}>Duration (hours)</label>
                  <select value={standbyHours} onChange={(e) => setStandbyHours(parseFloat(e.target.value) || 2)} className={inputStyle}>
                    <option value="0.5">0.5 hours (UPS applications)</option>
                    <option value="1">1 hour (Short backup)</option>
                    <option value="2">2 hours (Standard grid support)</option>
                    <option value="3">3 hours (Extended grid support)</option>
                    <option value="4">4 hours (Long duration storage)</option>
                    <option value="6">6 hours (Extended backup)</option>
                    <option value="8">8 hours (Overnight storage)</option>
                  </select>
                  <div className="text-xs text-gray-500 mt-1">
                    üí° Most BESS projects use 2-4 hours. Use longer durations only for specialized applications.
                  </div>
                </div>
                <div>
                  <label className={labelStyle}>Grid Mode</label>
                  <select value={gridMode} onChange={(e) => setGridMode(e.target.value)} className={inputStyle}>
                    <option>On-grid</option>
                    <option>Off-grid</option>
                    <option>Hybrid</option>
                  </select>
                </div>
                <div>
                  <label className={labelStyle}>Generator (MW)</label>
                  <input type="number" step="0.1" value={generatorMW} onChange={(e) => setGeneratorMW(parseFloat(e.target.value) || 0)} className={inputStyle} />
                </div>
                <div>
                  <label className={labelStyle}>Solar (MWp) - Optional</label>
                  <input type="number" step="0.1" value={solarMWp} onChange={(e) => setSolarMWp(parseFloat(e.target.value) || 0)} className={inputStyle} placeholder="0 (Battery only)" />
                  {solarMWp > 0 && (
                    <div className="text-xs text-amber-600 mt-1 p-2 bg-amber-50 rounded border border-amber-200">
                      ‚ö†Ô∏è {solarMWp}MW solar requires ~{(solarMWp * 100000 / 43560).toFixed(1)} acres of roof/land space. 
                      Verify your facility can support this before including in quote.
                    </div>
                  )}
                  <div className="text-xs text-gray-500 mt-1">
                    üí° Solar is optional - many BESS projects work great without it. Only add if you have adequate space and want renewable generation.
                  </div>
                </div>
                <div>
                  <label className={labelStyle}>Wind (MW)</label>
                  <input type="number" step="0.1" value={windMW} onChange={(e) => setWindMW(parseFloat(e.target.value) || 0)} className={inputStyle} />
                </div>
                <div>
                  <label className={labelStyle}>Utilization Rate (%)</label>
                  <input type="number" step="1" value={utilization * 100} onChange={(e) => setUtilization((parseFloat(e.target.value) || 0) / 100)} className={inputStyle} />
                </div>
                <div>
                  <label className={labelStyle}>Use Case</label>
                  <select value={useCase} onChange={(e) => setUseCase(e.target.value)} className={inputStyle}>
                    <option>EV Charging Stations</option>
                    <option>Data Centers</option>
                    <option>Manufacturing</option>
                    <option>Commercial Buildings</option>
                    <option>Utilities</option>
                  </select>
                </div>
                 <div>
                  <label className={labelStyle}>Warranty</label>
                  <select value={warranty} onChange={(e) => setWarranty(e.target.value)} className={inputStyle}>
                    <option>5 years</option>
                    <option>10 years</option>
                    <option>15 years</option>
                    <option>20 years</option>
                  </select>
                </div>
              </div>
            </section>

            {/* ASSUMPTIONS PANEL */}
            <section className="rounded-2xl p-8 shadow-2xl border-2 border-blue-300 bg-gradient-to-b from-blue-50 via-blue-100 to-white relative overflow-hidden">
              <div className="flex justify-between items-center mb-6">
                <h2 className="text-3xl font-bold bg-gradient-to-r from-blue-800 via-blue-600 to-blue-900 bg-clip-text text-transparent drop-shadow-sm">Pricing Assumptions</h2>
                <button
                  onClick={handleResetToDefaults}
                  className="bg-gradient-to-b from-orange-400 to-orange-600 hover:from-orange-300 hover:to-orange-500 text-white px-4 py-2 rounded-xl font-bold shadow-lg transition-colors duration-200 border-b-4 border-orange-700 hover:border-orange-800 flex items-center space-x-2"
                  title="Reset all values to default settings"
                >
                  <span className="text-sm">üîÑ</span>
                  <span>Reset</span>
                </button>
              </div>
              
              {/* Dynamic Pricing Info Box */}
              <div className="mb-4 p-4 bg-gradient-to-r from-green-100 to-blue-100 rounded-xl border-2 border-green-400">
                <p className="text-sm font-bold text-gray-800 mb-2">üí° Dynamic Market Pricing Active</p>
                <p className="text-xs text-gray-700">
                  Battery pricing auto-adjusts based on system size, duration, and location.
                  Current rate: <strong className="text-blue-700">${effectiveBatteryKwh}/kWh</strong>
                  {' '}({powerMW >= 2 ? 'Large Scale ‚â•2MW' : 'Small Scale <2MW'})
                </p>
                <p className="text-xs text-green-700 font-semibold mt-1">
                  ‚úÖ Based on BNEF 2024, NREL ATB, and industry contracts
                </p>
              </div>
              
              <div className="grid grid-cols-2 gap-x-6 gap-y-4">
                <div>
                  <label className={labelStyle}>
                    Battery ({getCurrencySymbol()}/kWh)
                    <span className="text-xs text-blue-600 ml-2">üìä Auto</span>
                  </label>
                  <input 
                    type="number" 
                    step="1" 
                    value={effectiveBatteryKwh} 
                    onChange={(e) => setBatteryKwh(parseFloat(e.target.value) || 0)} 
                    className={inputStyle}
                    title="Automatically calculated from market data. You can override manually."
                  />
                </div>
                <div>
                  <label className={labelStyle}>PCS ({getCurrencySymbol()}/kW)</label>
                  <input type="number" step="1" value={pcsKw} onChange={(e) => setPcsKw(parseFloat(e.target.value) || 0)} className={inputStyle} />
                </div>
                <div>
                  <label className={labelStyle}>BOS (%)</label>
                  <input type="number" step="1" value={(bosPercent * 100).toFixed(0)} onChange={(e) => setBosPercent((parseFloat(e.target.value) || 0) / 100)} className={inputStyle} />
                </div>
                <div>
                  <label className={labelStyle}>EPC (%)</label>
                  <input type="number" step="1" value={(epcPercent * 100).toFixed(0)} onChange={(e) => setEpcPercent((parseFloat(e.target.value) || 0) / 100)} className={inputStyle} />
                </div>
                <div>
                  <label className={labelStyle}>Off-Grid PCS Factor</label>
                  <input type="number" step="0.01" value={offGridPcsFactor} onChange={(e) => setOffGridPcsFactor(parseFloat(e.target.value) || 1.25)} className={inputStyle} />
                </div>
                <div>
                  <label className={labelStyle}>On-Grid PCS Factor</label>
                  <input type="number" step="0.01" value={onGridPcsFactor} onChange={(e) => setOnGridPcsFactor(parseFloat(e.target.value) || 1)} className={inputStyle} />
                </div>
                <div>
                  <label className={labelStyle}>Gen ({getCurrencySymbol()}/kW)</label>
                  <input type="number" step="1" value={genKw} onChange={(e) => setGenKw(parseFloat(e.target.value) || 0)} className={inputStyle} />
                </div>
                <div>
                  <label className={labelStyle}>Solar ({getCurrencySymbol()}/kWp)</label>
                  <input type="number" step="1" value={solarKwp} onChange={(e) => setSolarKwp(parseFloat(e.target.value) || 0)} className={inputStyle} />
                </div>
                <div>
                  <label className={labelStyle}>Wind ({getCurrencySymbol()}/kW)</label>
                  <input type="number" step="1" value={windKw} onChange={(e) => setWindKw(parseFloat(e.target.value) || 0)} className={inputStyle} />
                </div>
                <div>
                  <label className={labelStyle}>Battery Tariff (%)</label>
                  <input type="number" step="1" value="21" disabled className={inputStyle + " opacity-60"} title="Fixed at 21% for battery systems" />
                </div>
                <div>
                  <label className={labelStyle}>Other Equipment Tariff (%)</label>
                  <input type="number" step="1" value="6" disabled className={inputStyle + " opacity-60"} title="Fixed at 6% for solar, wind, and generators" />
                </div>
              </div>
              
              {/* Upload Pricing Data Button - Below Input Fields */}
              <div className="mt-8 pt-6 border-t-2 border-blue-300">
                <p className="text-sm font-semibold text-gray-700 mb-3 text-center">üìä Contribute to Market Intelligence</p>
                <button
                  onClick={() => {
                    openModal('showPricingDataCapture');
                  }}
                  className="w-full bg-gradient-to-br from-green-500 to-emerald-600 text-white px-6 py-4 rounded-xl font-bold shadow-lg hover:from-green-600 hover:to-emerald-700 transition-colors duration-200 flex items-center justify-center gap-3"
                  title="Upload your pricing data to improve market intelligence and earn credits"
                >
                  <span className="text-2xl">üìä</span>
                  <div className="text-center">
                    <div className="text-base font-bold">Upload Pricing Data</div>
                    <div className="text-sm opacity-90">Contribute & Earn Credits</div>
                  </div>
                </button>
              </div>
            </section>
          </div>

          {/* RIGHT COLUMN */}
          <div className="space-y-8">
            {/* FINANCIAL SUMMARY PANEL */}
            <section className="rounded-2xl p-8 shadow-2xl border-2 border-green-300 bg-gradient-to-b from-green-50 to-white relative overflow-hidden">
              <div className="flex justify-between items-center mb-6">
                <h2 className="text-3xl font-bold text-green-800 mb-8">Financial Summary</h2>
                <select
                  value={currency}
                  onChange={(e) => setCurrency(e.target.value)}
                  className="px-4 py-2 bg-white border-2 border-green-400 rounded-xl text-gray-800 font-bold focus:outline-none focus:border-green-600 focus:ring-2 focus:ring-green-300 shadow-md"
                >
                  <option value="USD">USD ($)</option>
                  <option value="EUR">EUR (‚Ç¨)</option>
                  <option value="GBP">GBP (¬£)</option>
                  <option value="JPY">JPY (¬•)</option>
                  <option value="CNY">CNY (¬•)</option>
                  <option value="CAD">CAD (C$)</option>
                  <option value="AUD">AUD (A$)</option>
                  <option value="INR">INR (‚Çπ)</option>
                  <option value="BRL">BRL (R$)</option>
                  <option value="MXN">MXN (MX$)</option>
                  <option value="KRW">KRW (‚Ç©)</option>
                </select>
              </div>
              <div className="space-y-3">
                <div className="bg-green-50 p-4 rounded-xl border-2 border-green-200 flex justify-between items-center">
                  <span className="text-gray-700 font-semibold text-lg">BESS CapEx:</span>
                  <span className="font-bold text-green-700 text-2xl">{getCurrencySymbol()}{convertCurrency(bessCapEx).toLocaleString(undefined, {maximumFractionDigits: 0})}</span>
                </div>
                <div className="bg-green-100 p-4 rounded-xl border-2 border-green-300 flex justify-between items-center">
                  <span className="text-gray-700 font-semibold text-lg">Grand CapEx:</span>
                  <span className="font-bold text-green-800 text-2xl">{getCurrencySymbol()}{convertCurrency(grandCapEx).toLocaleString(undefined, {maximumFractionDigits: 0})}</span>
                </div>
                <hr className="border-green-300 my-4" />
                <div className="bg-yellow-50 p-4 rounded-xl border-2 border-yellow-200 flex justify-between items-center">
                  <span className="text-gray-700 font-semibold text-lg">Annual Savings:</span>
                  <span className="font-bold text-yellow-700 text-2xl">{getCurrencySymbol()}{convertCurrency(annualSavings).toLocaleString(undefined, {maximumFractionDigits: 0})}/yr</span>
                </div>
                <div className="bg-yellow-100 p-4 rounded-xl border-2 border-yellow-300 flex justify-between items-center">
                  <span className="text-gray-700 font-semibold text-lg">Simple ROI:</span>
                  <span className="font-bold text-orange-700 text-2xl">{roiYears.toFixed(2)} years</span>
                </div>
              </div>
              <div className="mt-8 space-y-3">
                <button 
                  className="w-full bg-gradient-to-r from-green-600 to-emerald-700 hover:from-green-500 hover:to-emerald-600 text-white px-6 py-4 rounded-lg font-semibold shadow-lg transition-all duration-200 border border-green-400/30"
                  onClick={handleExportWord}
                >
                  üìÑ Export to Word
                </button>
                <button 
                  className="w-full bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-500 hover:to-indigo-600 text-white px-6 py-4 rounded-lg font-semibold shadow-lg transition-all duration-200 border border-blue-400/30"
                  onClick={() => openModal('showCalculationModal')}
                  title="View detailed formulas and assumptions"
                >
                  üßÆ View Calculation Details
                </button>
                <button 
                  className="w-full bg-gradient-to-r from-purple-600 to-fuchsia-700 hover:from-purple-500 hover:to-fuchsia-600 text-white px-6 py-4 rounded-lg font-semibold shadow-lg transition-all duration-200 border border-purple-400/30"
                  onClick={handleExportCalculations}
                  title="Export detailed formulas to text file"
                >
                  üíæ Export Formulas (TXT)
                </button>
                <div className="mt-6 pt-6 border-t-2 border-green-200">
                  <p className="text-sm text-gray-600 font-semibold mb-3 text-center">Advanced Tools</p>
                  <div className="space-y-3">
                    <button 
                      className="w-full bg-gradient-to-r from-cyan-600 to-blue-700 hover:from-cyan-500 hover:to-blue-600 text-white px-6 py-4 rounded-lg font-semibold shadow-lg transition-all duration-200 border border-cyan-400/30"
                      onClick={() => openModal('showAnalytics')}
                      title="NPV, IRR, ROI, and sensitivity analysis"
                    >
                      üìä Advanced Analytics
                    </button>
                    <button 
                      className="w-full bg-gradient-to-r from-emerald-600 to-teal-700 hover:from-emerald-500 hover:to-teal-600 text-white px-6 py-4 rounded-lg font-semibold shadow-lg transition-all duration-200 border border-emerald-400/30"
                      onClick={() => openModal('showFinancing')}
                      title="Compare loan, lease, and PPA options"
                    >
                      üéØ Financing Calculator
                    </button>
                    <button 
                      className="w-full bg-gradient-to-r from-violet-600 to-purple-700 hover:from-violet-500 hover:to-purple-600 text-white px-6 py-4 rounded-lg font-semibold shadow-lg transition-all duration-200 border border-violet-400/30"
                      onClick={() => openModal('showTemplates')}
                      title="Pre-configured BESS templates for common use cases"
                    >
                      üéØ Use Case Templates
                    </button>
                  </div>
                </div>

                {/* Quote Customization Section */}
                <div className="mt-6 pt-6 border-t-2 border-blue-200">
                  <p className="text-sm text-gray-600 font-semibold mb-3 text-center">Quote Customization</p>
                  <div className="space-y-3">
                    <button 
                      className="w-full bg-gradient-to-r from-sky-400 to-blue-500 hover:from-sky-300 hover:to-blue-400 text-white px-6 py-4 rounded-lg font-semibold shadow-lg transition-all duration-200 border border-sky-300/30"
                      onClick={() => openModal('showUtilityRates')}
                      title="Select regional utility rates for accurate pricing"
                    >
                      ‚ö° Regional Utility Rates
                    </button>
                    <button 
                      className="w-full bg-gradient-to-r from-gray-400 to-gray-500 hover:from-gray-300 hover:to-gray-400 text-white px-6 py-4 rounded-lg font-semibold shadow-lg transition-all duration-200 border border-gray-300/30"
                      onClick={() => openModal('showQuoteTemplates')}
                      title="Customize quote templates for different project types"
                    >
                      üìã Quote Templates
                    </button>
                    <button 
                      className="w-full bg-gradient-to-r from-gray-400 to-gray-500 hover:from-gray-300 hover:to-gray-400 text-white px-6 py-4 rounded-lg font-semibold shadow-lg transition-all duration-200 border border-gray-300/30"
                      onClick={() => openModal('showPricingPresets')}
                      title="Save your pricing presets & EPC contractor fees"
                    >
                      üéØ My Pricing Presets
                    </button>
                    <button 
                      className="w-full bg-gradient-to-r from-purple-500 to-violet-600 hover:from-purple-400 hover:to-violet-500 text-white px-6 py-4 rounded-lg font-semibold shadow-lg transition-all duration-200 border border-purple-400/30 relative"
                      onClick={() => openModal('showReviewWorkflow')}
                      title="Manage quote review and approval workflow"
                    >
                      <span>‚úì Review Workflow</span>
                      {currentQuoteStatus !== 'draft' && (
                        <span className="ml-2 px-2 py-1 text-xs bg-white/20 rounded capitalize">
                          {currentQuoteStatus}
                        </span>
                      )}
                      {currentQuoteStatus === 'in-review' && (
                        <span className="absolute -top-1 -right-1 w-3 h-3 bg-yellow-400 rounded-full animate-pulse"></span>
                      )}
                      {currentQuoteStatus === 'approved' && (
                        <span className="absolute -top-1 -right-1 w-3 h-3 bg-green-400 rounded-full"></span>
                      )}
                    </button>
                  </div>
                </div>
              </div>
            </section>

            {/* SYSTEM DETAILS PANEL */}
            <section className="rounded-2xl p-8 shadow-2xl border-2 border-cyan-300 bg-gradient-to-b from-cyan-50 via-blue-50 to-white relative overflow-hidden">
              <h2 className="text-3xl font-bold text-cyan-800 mb-6">System Details</h2>
              <div className="space-y-4">
                <div className="bg-blue-50 p-4 rounded-xl border-2 border-blue-200 flex justify-between items-center">
                  <div>
                    <div className="text-gray-800 font-semibold text-lg">Total Energy:</div>
                    <div className="text-xs text-gray-600">
                      Realistic Duration: {actualDuration.toFixed(1)}hr 
                      {actualDuration !== standbyHours && (
                        <span className="text-amber-600"> (adjusted from {standbyHours}hr)</span>
                      )}
                    </div>
                  </div>
                  <span className="font-bold text-blue-700 text-2xl">{totalMWh.toFixed(2)} MWh</span>
                </div>
                <div className="bg-blue-100 p-4 rounded-xl border-2 border-blue-300 flex justify-between items-center">
                  <span className="text-gray-800 font-semibold text-lg">PCS Power:</span>
                  <span className="font-bold text-blue-800 text-2xl">{pcsKW.toFixed(2)} kW</span>
                </div>
                <div className="bg-cyan-50 p-4 rounded-xl border-2 border-cyan-200 flex justify-between items-center">
                  <span className="text-gray-800 font-semibold text-lg">Annual Energy:</span>
                  <span className="font-bold text-cyan-700 text-2xl">{annualEnergyMWh.toFixed(2)} MWh</span>
                </div>
              </div>
            </section>
          </div>
        </div>
        </>
      )}

      {/* Footer with Admin Access */}
        <footer className="mt-12 border-t border-purple-300 pt-8 pb-6">
          <div className="text-center">
            <div className="flex items-center justify-center gap-4 mb-4">
              <button
                onClick={() => openModal('showStatusPage')}
                className="text-gray-600 hover:text-green-600 text-xs font-medium transition-colors inline-flex items-center gap-1"
              >
                <span>üü¢</span>
                <span>System Status</span>
              </button>
              <span className="text-gray-300">|</span>
              <button
                onClick={() => openModal('showPrivacyPolicy')}
                className="text-gray-600 hover:text-blue-600 text-xs font-medium transition-colors"
              >
                Privacy Policy
              </button>
              <span className="text-gray-300">|</span>
              <button
                onClick={() => openModal('showTermsOfService')}
                className="text-gray-600 hover:text-purple-600 text-xs font-medium transition-colors"
              >
                Terms of Service
              </button>
              <span className="text-gray-300">|</span>
              <button
                onClick={() => openModal('showSecuritySettings')}
                className="text-gray-600 hover:text-green-600 text-xs font-medium transition-colors inline-flex items-center gap-1"
              >
                <span>üîí</span>
                <span>Security & Privacy</span>
              </button>
            </div>
            <p className="text-gray-600 text-sm mb-4">
              ¬© 2025 Merlin Energy. All rights reserved.
            </p>
            {isLoggedIn && (
              <div className="flex items-center justify-center gap-4">
                <button
                  onClick={() => openModal('showSystemHealth')}
                  className="text-gray-600 hover:text-blue-600 text-xs font-medium transition-colors inline-flex items-center gap-1"
                >
                  <span>üìä</span>
                  <span>System Health</span>
                </button>
                <span className="text-gray-300">|</span>
                <button
                  onClick={() => openModal('showVendorManager')}
                  className="text-gray-600 hover:text-purple-600 text-xs font-medium transition-colors inline-flex items-center gap-1"
                >
                  <span>üîß</span>
                  <span>Admin Panel</span>
                </button>
                <span className="text-gray-300">|</span>
                <button
                  onClick={() => {
                    setIsLoggedIn(false);
                    alert('You have been logged out successfully');
                  }}
                  className="text-gray-600 hover:text-red-600 text-xs font-medium transition-colors inline-flex items-center gap-1"
                >
                  <span>üö™</span>
                  <span>Sign Out</span>
                </button>
              </div>
            )}
          </div>
        </footer>
      </main>

      {/* Modals */}
      {isModalOpen('showUserProfile') && (
        <EditableUserProfile 
          onClose={() => closeModal('showUserProfile')} 
          onLoginSuccess={handleLoginSuccess} 
          onLogout={() => setIsLoggedIn(false)} 
          isLoggedIn={isLoggedIn}
          onShowQuoteTemplates={() => openModal('showQuoteTemplates')}
          onShowPricingPresets={() => openModal('showPricingPresets')}
          onShowVendorLeads={() => openModal('showVendorSponsorship')}
        />
      )}
      {isModalOpen('showPortfolio') && <Portfolio onClose={() => closeModal('showPortfolio')} onLoadQuote={loadProjectFromStorage} />}
      {isModalOpen('showAuthModal') && <AuthModal isOpen={isModalOpen('showAuthModal')} onClose={() => closeModal('showAuthModal')} onLoginSuccess={handleLoginSuccess} />}
      {isModalOpen('showVendorManager') && <VendorManager isOpen={isModalOpen('showVendorManager')} onClose={() => closeModal('showVendorManager')} />}
      {isModalOpen('showPricingPlans') && (
        <PricingPlans 
          onClose={() => closeModal('showPricingPlans')} 
          onSignUp={() => {
            closeModal('showPricingPlans');
            openModal('showAuthModal');
          }}
          currentTier="free" 
        />
      )}
      
      {/* Welcome and Account Setup Modals */}
      {isModalOpen('showWelcomeModal') && (
        <WelcomeModal
          onClose={handleGoHome}
          userName={authService.getCurrentUser()?.firstName || 'User'}
          onSetupProfile={handleProfileSetup}
          onStartWizard={handleStartWizard}
          onGoHome={handleGoHome}
        />
      )}
      {isModalOpen('showAccountSetup') && (
        <AccountSetup
          onClose={() => closeModal('showAccountSetup')}
          onComplete={handleProfileComplete}
          onContinueToProfile={handleContinueToEnhancedProfile}
          userName={authService.getCurrentUser()?.firstName || 'User'}
          accountType={authService.getCurrentUser()?.accountType || 'individual'}
          companyName={authService.getCurrentUser()?.company}
        />
      )}
      {isModalOpen('showEnhancedProfile') && (
        <EnhancedProfile
          onClose={handleEnhancedProfileClose}
          isFirstTime={isFirstTimeProfile}
        />
      )}
  
      {/* Join Merlin Modal - Shows benefits first */}
      <Suspense fallback={<ModalLoader />}>
        <JoinMerlinModal 
          isOpen={isModalOpen('showJoinModal')}
          onClose={() => closeModal('showJoinModal')}
          onViewPricing={() => {
            closeModal('showJoinModal');
            openModal('showPricingPlans');
          }}
        />
      </Suspense>
      
      <Suspense fallback={<ModalLoader />}>
        <SmartWizard
          show={isModalOpen('showSmartWizard')}
          onClose={() => closeModal('showSmartWizard')}
          onFinish={(wizardData) => {
            // Map wizard data to the main form
            setPowerMW(wizardData.storageSizeMW || 1);
            setStandbyHours(wizardData.durationHours || 2);
          
          // Map application to use case
          const applicationMap: { [key: string]: string } = {
            'ev-charging': 'EV Charging Stations',
            'data-center': 'Data Centers',
            'manufacturing': 'Manufacturing',
            'commercial': 'Commercial Buildings',
            'utility': 'Utility Scale',
            'resiliency': 'Critical Infrastructure',
          };
          setUseCase(applicationMap[wizardData.primaryApplication] || 'EV Charging Stations');
          
          // Set warranty
          setWarranty(`${wizardData.warranty} years`);
          
          // Set renewable energy and generator values from wizard
          setSolarMWp(wizardData.solarMW || 0);
          setWindMW(wizardData.windMW || 0);
          setGeneratorMW(wizardData.generatorMW || 0);
          
          // Close wizard and show success message
          closeModal('showSmartWizard');
          
          // Scroll to top to show the updated configuration
          window.scrollTo({ top: 0, behavior: 'smooth' });
          
          // Show success notification
          setTimeout(() => {
            alert(`üéâ Configuration Applied Successfully!\n\n` +
                  `BESS Power: ${wizardData.power} MW\n` +
                  `Duration: ${wizardData.duration} hours\n` +
                  `Solar: ${wizardData.solarMW || 0} MW\n` +
                  `Wind: ${wizardData.windMW || 0} MW\n` +
                  `Generator: ${wizardData.generatorMW || 0} MW\n` +
                  `Grid: ${wizardData.gridConnection === 'behind' ? 'Behind the meter' : 'Front of meter'}\n` +
                  `Application: ${applicationMap[wizardData.primaryApplication]}\n\n` +
                  `Your quote has been updated. Review the details below and click "Generate Quote" when ready.`);
          }, 500);
        }}
      />
      </Suspense>

      {/* Calculation Modal */}
      {isModalOpen('showCalculationModal') && (
        <Suspense fallback={<ModalLoader />}>
          <CalculationModal
            isOpen={isModalOpen('showCalculationModal')}
            onClose={() => closeModal('showCalculationModal')}
            calculations={generateCalculationBreakdown(
              powerMW,
            standbyHours,
            solarMWp,
            windMW,
            generatorMW,
            batteryKwh,
            pcsKw,
            bosPercent,
            epcPercent,
            genKw,
            solarKwp,
            windKw,
            location
          )}
          projectName={quoteName}
        />
        </Suspense>
      )}

      {/* Save Project Modal */}
      <SaveProjectModal
        isOpen={isModalOpen('showSaveProjectModal')}
        onClose={() => closeModal('showSaveProjectModal')}
        onUploadProject={handleUploadProject}
        onCreateWithWizard={handleCreateWithWizard}
      />

      {/* Load Project Modal */}
      <LoadProjectModal
        isOpen={isModalOpen('showLoadProjectModal')}
        onClose={() => closeModal('showLoadProjectModal')}
        onUploadFromComputer={handleUploadFromComputer}
        onUploadFromPortfolio={handleUploadFromPortfolio}
      />

      {/* Advanced Analytics Modal */}
      {isModalOpen('showAnalytics') && (
        <AdvancedAnalytics
          isOpen={isModalOpen('showAnalytics')}
          onClose={() => closeModal('showAnalytics')}
          projectData={{
            quoteName,
            powerMW,
            durationHours: standbyHours,
            totalCapEx: grandCapEx,
            annualSavings,
          }}
        />
      )}

      {/* ML Analytics Suite - EnhancedBESSAnalytics Component */}
      {isModalOpen('showEnhancedAnalytics') && (() => {
        try {
          return (
            <EnhancedBESSAnalytics
              isOpen={isModalOpen('showEnhancedAnalytics')}
              onClose={() => {
                closeModal('showEnhancedAnalytics');
              }}
              projectData={{
                quoteName,
                storageSizeMW: powerMW,
                durationHours: actualDuration,
                useCase,
                location: selectedCountry,
              }}
            />
          );
        } catch (error) {
          return <div>Error loading ML Analytics</div>;
        }
      })()}

      {/* Financing Calculator Modal */}
      {isModalOpen('showFinancing') && (
        <FinancingCalculator
          isOpen={isModalOpen('showFinancing')}
          onClose={() => closeModal('showFinancing')}
          projectData={{
            quoteName,
            totalCapEx: grandCapEx,
            annualSavings,
            powerMW,
            durationHours: standbyHours,
          }}
        />
      )}

      {/* Use Case Templates Modal */}
      {isModalOpen('showTemplates') && (
        <UseCaseTemplates
          isOpen={isModalOpen('showTemplates')}
          onClose={() => closeModal('showTemplates')}
          onApplyTemplate={handleApplyTemplate}
        />
      )}

      {/* Pricing Data Capture Modal */}
      {isModalOpen('showPricingDataCapture') && (
        <PricingDataCapture
          onClose={() => closeModal('showPricingDataCapture')}
          userEmail={authService.getCurrentUser()?.email}
        />
      )}

      {/* Market Intelligence Dashboard */}
      {isModalOpen('showMarketIntelligence') && (
        <MarketIntelligenceDashboard
          onClose={() => closeModal('showMarketIntelligence')}
          userTier={authService.getCurrentUser()?.tier as 'free' | 'professional' | 'enterprise_pro' | 'business'}
        />
      )}

      {/* Vendor Sponsorship Marketplace */}
      {isModalOpen('showVendorSponsorship') && (
        <VendorSponsorship
          onClose={() => closeModal('showVendorSponsorship')}
        />
      )}

      {/* Privacy Policy */}
      {isModalOpen('showPrivacyPolicy') && (
        <PrivacyPolicy
          onClose={() => closeModal('showPrivacyPolicy')}
        />
      )}

      {/* Terms of Service */}
      {isModalOpen('showTermsOfService') && (
        <TermsOfService
          onClose={() => closeModal('showTermsOfService')}
        />
      )}

      {/* Security & Privacy Settings */}
      {isModalOpen('showSecuritySettings') && (
        <SecurityPrivacySettings
          onClose={() => closeModal('showSecuritySettings')}
        />
      )}

      {/* System Health Dashboard */}
      {isModalOpen('showSystemHealth') && (
        <SystemHealth
          onClose={() => closeModal('showSystemHealth')}
        />
      )}

      {/* Public Status Page */}
      {isModalOpen('showStatusPage') && (
        <StatusPage
          onClose={() => closeModal('showStatusPage')}
        />
      )}

      {/* Utility Rates Manager */}
      {isModalOpen('showUtilityRates') && (
        <UtilityRatesManager
          onClose={() => closeModal('showUtilityRates')}
          onSelectRate={(rate, rateType) => {
            // Apply selected utility rate to the quote
            const selectedRate = rateType === 'residential' ? rate.residentialRate :
                                rateType === 'commercial' ? rate.commercialRate :
                                rate.industrialRate;
            setValueKwh(selectedRate);
            alert(`Utility rate updated to $${selectedRate.toFixed(3)}/kWh from ${rate.utility}`);
          }}
          currentRate={valueKwh}
        />
      )}

      {/* Quote Templates */}
      {isModalOpen('showQuoteTemplates') && (
        <QuoteTemplates
          onClose={() => closeModal('showQuoteTemplates')}
          onSelectTemplate={(template) => {
            alert(`Template "${template.name}" selected! Quote generation will use this template.`);
            // Template will be used when generating the quote document
          }}
          userId={authService.getCurrentUser()?.email || 'guest'}
        />
      )}

      {/* Pricing Presets */}
      {isModalOpen('showPricingPresets') && (
        <PricingPresets
          onClose={() => closeModal('showPricingPresets')}
          onSelectPreset={(preset) => {
            // Apply preset pricing to quote builder
            alert(`Pricing preset "${preset.name}" applied!\n\nBattery: $${preset.battery.pricePerKWh}/kWh\nInverter: $${preset.inverter.pricePerKW}/kW\n${preset.epc.enabled ? 'EPC fees included' : ''}`);
            // Pricing will be applied to calculations
          }}
          userId={authService.getCurrentUser()?.email || 'guest'}
        />
      )}

      {/* Quote Review Workflow */}
      {isModalOpen('showReviewWorkflow') && (
        <QuoteReviewWorkflow
          onClose={() => closeModal('showReviewWorkflow')}
          quoteId={`quote-${quoteName.replace(/\s+/g, '-').toLowerCase()}`}
          quoteName={quoteName}
          userId={authService.getCurrentUser()?.email || 'guest'}
          userName={authService.getCurrentUser()?.email || 'Guest User'}
          onStatusChange={(status) => {
            setCurrentQuoteStatus(status);
          }}
        />
      )}

      {/* Cost Savings Benefits Modal */}
      {isModalOpen('showCostSavingsModal') && (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div className="sticky top-0 bg-gradient-to-r from-green-500 to-emerald-600 text-white p-6 rounded-t-2xl">
              <div className="flex justify-between items-center">
                <h2 className="text-3xl font-bold">üéØ Reduce Energy Costs</h2>
                <button 
                  onClick={() => closeModal('showCostSavingsModal')}
                  className="text-white hover:text-gray-200 text-3xl font-bold"
                >√ó</button>
              </div>
            </div>
            <div className="p-8">
              <p className="text-xl text-gray-700 mb-6 leading-relaxed">
                Energy storage systems help you dramatically reduce electricity costs by storing energy when it's cheap and using it when prices are high.
              </p>
              
              <h3 className="text-2xl font-bold text-gray-900 mb-4">How It Works</h3>
              <div className="space-y-4 mb-6">
                <div className="bg-green-50 border-l-4 border-green-500 p-4 rounded">
                  <h4 className="font-bold text-green-900 mb-2">Peak Shaving</h4>
                  <p className="text-gray-700">Store energy during off-peak hours (when electricity is cheap) and discharge during peak hours (when rates are highest). Save 30-50% on peak energy charges.</p>
                </div>
                <div className="bg-green-50 border-l-4 border-green-500 p-4 rounded">
                  <h4 className="font-bold text-green-900 mb-2">Demand Charge Reduction</h4>
                  <p className="text-gray-700">Reduce your peak demand by supplementing grid power with battery power. Commercial customers can save thousands per month on demand charges alone.</p>
                </div>
                <div className="bg-green-50 border-l-4 border-green-500 p-4 rounded">
                  <h4 className="font-bold text-green-900 mb-2">Time-of-Use Optimization</h4>
                  <p className="text-gray-700">Automatically shift your energy consumption to the lowest-cost periods, maximizing savings without any operational changes.</p>
                </div>
              </div>

              <h3 className="text-2xl font-bold text-gray-900 mb-4">Real-World Savings</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div className="bg-gray-50 p-4 rounded-lg">
                  <div className="text-3xl font-bold text-green-600 mb-2">$50,000+</div>
                  <p className="text-gray-600">Average annual savings for manufacturing facilities</p>
                </div>
                <div className="bg-gray-50 p-4 rounded-lg">
                  <div className="text-3xl font-bold text-green-600 mb-2">30-50%</div>
                  <p className="text-gray-600">Reduction in peak energy charges</p>
                </div>
                <div className="bg-gray-50 p-4 rounded-lg">
                  <div className="text-3xl font-bold text-green-600 mb-2">$0.10-0.25</div>
                  <p className="text-gray-600">Savings per kWh with arbitrage</p>
                </div>
                <div className="bg-gray-50 p-4 rounded-lg">
                  <div className="text-3xl font-bold text-green-600 mb-2">4-7 years</div>
                  <p className="text-gray-600">Typical payback period</p>
                </div>
              </div>

              <div className="bg-blue-50 border-l-4 border-blue-500 p-4 rounded mb-6">
                <p className="text-gray-700"><strong>Example:</strong> A 2 MW / 4 MWh system for a manufacturing facility can save $50,000-$100,000 annually through peak shaving and demand charge reduction alone.</p>
              </div>

              <button 
                onClick={() => {
                  closeModal('showCostSavingsModal');
                  openModal('showSmartWizard');
                }}
                className="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white px-8 py-4 rounded-xl font-bold text-lg hover:from-green-600 hover:to-emerald-700 transition-colors flex items-center justify-center gap-3"
              >
                <span className="text-2xl">üéØ</span>
                Calculate Your Savings with Smart Wizard
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Revenue Generation Benefits Modal */}
      {isModalOpen('showRevenueModal') && (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div className="sticky top-0 bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-6 rounded-t-2xl">
              <div className="flex justify-between items-center">
                <h2 className="text-3xl font-bold">üéØ Generate Revenue</h2>
                <button 
                  onClick={() => closeModal('showRevenueModal')}
                  className="text-white hover:text-gray-200 text-3xl font-bold"
                >√ó</button>
              </div>
            </div>
            <div className="p-8">
              <p className="text-xl text-gray-700 mb-6 leading-relaxed">
                Transform your energy storage system from a cost-saving tool into an active revenue generator by participating in grid services and energy markets.
              </p>
              
              <h3 className="text-2xl font-bold text-gray-900 mb-4">Revenue Streams</h3>
              <div className="space-y-4 mb-6">
                <div className="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                  <h4 className="font-bold text-blue-900 mb-2">Frequency Regulation</h4>
                  <p className="text-gray-700">Get paid to help stabilize the electric grid by providing fast-response power. Earn $10-50/kW-year depending on your market.</p>
                </div>
                <div className="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                  <h4 className="font-bold text-blue-900 mb-2">Demand Response Programs</h4>
                  <p className="text-gray-700">Utilities pay you to reduce consumption during peak events. Typical payments: $50-200/kW-year.</p>
                </div>
                <div className="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                  <h4 className="font-bold text-blue-900 mb-2">Energy Arbitrage</h4>
                  <p className="text-gray-700">Buy low, sell high. Charge when electricity is cheap, discharge when prices spike. Can generate $20-100/kWh-year.</p>
                </div>
                <div className="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                  <h4 className="font-bold text-blue-900 mb-2">Capacity Markets</h4>
                  <p className="text-gray-700">Get paid simply for having capacity available when the grid needs it. Steady income stream of $30-150/kW-year.</p>
                </div>
              </div>

              <h3 className="text-2xl font-bold text-gray-900 mb-4">Revenue Potential</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div className="bg-gray-50 p-4 rounded-lg">
                  <div className="text-3xl font-bold text-blue-600 mb-2">$100K-300K</div>
                  <p className="text-gray-600">Annual revenue for 5 MW system in ERCOT</p>
                </div>
                <div className="bg-gray-50 p-4 rounded-lg">
                  <div className="text-3xl font-bold text-blue-600 mb-2">3-5 years</div>
                  <p className="text-gray-600">Typical ROI with stacked revenue</p>
                </div>
                <div className="bg-gray-50 p-4 rounded-lg">
                  <div className="text-3xl font-bold text-blue-600 mb-2">15-25%</div>
                  <p className="text-gray-600">IRR for well-optimized systems</p>
                </div>
                <div className="bg-gray-50 p-4 rounded-lg">
                  <div className="text-3xl font-bold text-blue-600 mb-2">Multiple</div>
                  <p className="text-gray-600">Stack 3-5 revenue streams simultaneously</p>
                </div>
              </div>

              <div className="bg-purple-50 border-l-4 border-purple-500 p-4 rounded mb-6">
                <p className="text-gray-700"><strong>Best Markets:</strong> ERCOT (Texas), CAISO (California), PJM (Mid-Atlantic), and ISO-NE (New England) offer the most lucrative opportunities for battery storage revenue.</p>
              </div>

              <button 
                onClick={() => {
                  closeModal('showRevenueModal');
                  openModal('showSmartWizard');
                }}
                className="w-full bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-8 py-4 rounded-xl font-bold text-lg hover:from-blue-600 hover:to-indigo-700 transition-colors flex items-center justify-center gap-3"
              >
                <span className="text-2xl">üéØ</span>
                Model Your Revenue with Smart Wizard
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Sustainability Benefits Modal */}
      {isModalOpen('showSustainabilityModal') && (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div className="sticky top-0 bg-gradient-to-r from-emerald-500 to-teal-600 text-white p-6 rounded-t-2xl">
              <div className="flex justify-between items-center">
                <h2 className="text-3xl font-bold">üå± Achieve Sustainability</h2>
                <button 
                  onClick={() => closeModal('showSustainabilityModal')}
                  className="text-white hover:text-gray-200 text-3xl font-bold"
                >√ó</button>
              </div>
            </div>
            <div className="p-8">
              <p className="text-xl text-gray-700 mb-6 leading-relaxed">
                Energy storage is essential for achieving net-zero goals, maximizing renewable energy use, and qualifying for valuable tax incentives.
              </p>
              
              <h3 className="text-2xl font-bold text-gray-900 mb-4">Environmental Benefits</h3>
              <div className="space-y-4 mb-6">
                <div className="bg-emerald-50 border-l-4 border-emerald-500 p-4 rounded">
                  <h4 className="font-bold text-emerald-900 mb-2">Maximize Renewable Energy</h4>
                  <p className="text-gray-700">Store excess solar and wind energy for use when the sun isn't shining or wind isn't blowing. Increase renewable usage from 30% to 80%+.</p>
                </div>
                <div className="bg-emerald-50 border-l-4 border-emerald-500 p-4 rounded">
                  <h4 className="font-bold text-emerald-900 mb-2">Reduce Carbon Footprint</h4>
                  <p className="text-gray-700">Offset fossil fuel consumption by using stored clean energy. A 2 MW / 4 MWh system can eliminate 500+ tons of CO‚ÇÇ annually.</p>
                </div>
                <div className="bg-emerald-50 border-l-4 border-emerald-500 p-4 rounded">
                  <h4 className="font-bold text-emerald-900 mb-2">Enable Grid Decarbonization</h4>
                  <p className="text-gray-700">Help integrate more renewable energy onto the grid by providing essential grid services and reducing curtailment.</p>
                </div>
                <div className="bg-emerald-50 border-l-4 border-emerald-500 p-4 rounded">
                  <h4 className="font-bold text-emerald-900 mb-2">Energy Independence</h4>
                  <p className="text-gray-700">Combined with solar, achieve near-complete energy independence. Protect against outages while reducing grid reliance.</p>
                </div>
              </div>

              <h3 className="text-2xl font-bold text-gray-900 mb-4">Financial Incentives</h3>
              <div className="space-y-4 mb-6">
                <div className="bg-green-50 p-4 rounded-lg border-2 border-green-400">
                  <h4 className="font-bold text-green-900 mb-2 text-xl">30% Federal Investment Tax Credit (ITC)</h4>
                  <p className="text-gray-700 mb-2">Reduces your system cost by 30% when paired with solar. A $1M system becomes $700K after the credit.</p>
                  <p className="text-sm text-gray-600">Available through 2032, then phases down to 26% (2033), 22% (2034)</p>
                </div>
                <div className="bg-blue-50 p-4 rounded-lg">
                  <h4 className="font-bold text-blue-900 mb-2">Accelerated Depreciation (MACRS)</h4>
                  <p className="text-gray-700">Depreciate 85% of system value over 5 years. Additional $150K-300K in tax savings for typical commercial systems.</p>
                </div>
                <div className="bg-purple-50 p-4 rounded-lg">
                  <h4 className="font-bold text-purple-900 mb-2">State & Local Incentives</h4>
                  <p className="text-gray-700">Many states offer additional rebates, grants, and incentives. California's SGIP program offers up to $200/kWh.</p>
                </div>
              </div>

              <h3 className="text-2xl font-bold text-gray-900 mb-4">Corporate Benefits</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div className="bg-gray-50 p-4 rounded-lg">
                  <div className="text-2xl font-bold text-emerald-600 mb-2">‚úì ESG Reporting</div>
                  <p className="text-gray-600">Demonstrate environmental commitment to stakeholders</p>
                </div>
                <div className="bg-gray-50 p-4 rounded-lg">
                  <div className="text-2xl font-bold text-emerald-600 mb-2">‚úì Brand Value</div>
                  <p className="text-gray-600">Enhance reputation with sustainability leadership</p>
                </div>
                <div className="bg-gray-50 p-4 rounded-lg">
                  <div className="text-2xl font-bold text-emerald-600 mb-2">‚úì Future-Proof</div>
                  <p className="text-gray-600">Prepare for carbon pricing and regulations</p>
                </div>
                <div className="bg-gray-50 p-4 rounded-lg">
                  <div className="text-2xl font-bold text-emerald-600 mb-2">‚úì Certifications</div>
                  <p className="text-gray-600">Qualify for LEED, ENERGY STAR, and more</p>
                </div>
              </div>

              <button 
                onClick={() => {
                  closeModal('showSustainabilityModal');
                  openModal('showSmartWizard');
                }}
                className="w-full bg-gradient-to-r from-emerald-500 to-teal-600 text-white px-8 py-4 rounded-xl font-bold text-lg hover:from-emerald-600 hover:to-teal-700 transition-colors flex items-center justify-center gap-3"
              >
                <span className="text-2xl">üéØ</span>
                Calculate Your Environmental Impact
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Templates Modal */}
      {isModalOpen('showTemplates') && (
        <UseCaseTemplates 
          isOpen={isModalOpen('showTemplates')} 
          onClose={() => closeModal('showTemplates')} 
          onApplyTemplate={(template) => {
            // Apply the template configuration
            setPowerMW(template.configuration.powerMW);
            setStandbyHours(template.configuration.durationHours);
            closeModal('showTemplates');
          }}
        />
      )}

      {/* Financing Calculator Modal */}
      {isModalOpen('showFinancing') && (
        <FinancingCalculator 
          isOpen={isModalOpen('showFinancing')} 
          onClose={() => closeModal('showFinancing')} 
          projectData={{
            quoteName: `${applicationType || 'BESS'} Project`,
            totalCapEx: systemCost.totalCost,
            annualSavings: annualSavings || 0,
            powerMW: powerMW,
            durationHours: standbyHours,
          }}
        />
      )}

        {/* Enhanced Analytics Modal - Real Component */}
        {isModalOpen('showEnhancedAnalytics') && (
          <AdvancedAnalytics 
            isOpen={isModalOpen('showEnhancedAnalytics')}
            onClose={() => closeModal('showEnhancedAnalytics')}
            projectData={{
              quoteName: `${applicationType || 'BESS'} Project`,
              powerMW: powerMW,
              durationHours: standbyHours,
              totalCapEx: systemCost.totalCost,
              annualSavings: annualSavings || 0,
              batteryLifeYears: 15,
              discountRate: 0.08,
            }}
          />
        )}

      {/* Advanced BESS Analytics Modal - Financial Analytics */}
      {isModalOpen('showEnhancedBESSAnalytics') && (() => {
        return (
          <AdvancedAnalytics 
            isOpen={isModalOpen('showEnhancedBESSAnalytics')}
            onClose={() => {
              closeModal('showEnhancedBESSAnalytics');
            }}
            projectData={{
              quoteName: `${applicationType || 'BESS'} Project`,
              powerMW: powerMW,
              durationHours: standbyHours,
              totalCapEx: grandCapEx,
              annualSavings: annualSavings,
              batteryLifeYears: 15,
              discountRate: 0.08,
            }}
          />
        );
      })()}

      {/* Chat Modal */}
      {isModalOpen('showChatModal') && (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div className="sticky top-0 bg-gradient-to-r from-green-500 to-emerald-600 text-white p-6 rounded-t-2xl">
              <div className="flex justify-between items-center">
                <h2 className="text-3xl font-bold">üí¨ AI Assistant Chat</h2>
                <button 
                  onClick={() => closeModal('showChatModal')}
                  className="text-white hover:text-gray-200 text-3xl font-bold"
                >√ó</button>
              </div>
            </div>
            <div className="p-8">
              <div className="text-center py-12">
                <h3 className="text-2xl font-bold text-gray-800 mb-4">ü§ñ AI Chat Assistant Coming Soon</h3>
                <p className="text-lg text-gray-600 mb-6">
                  Get instant answers about energy storage from our AI assistant:
                </p>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 text-left">
                  <div className="bg-green-50 p-4 rounded-lg">
                    <h4 className="font-bold text-green-900 mb-2">üí° Technical Questions</h4>
                    <p className="text-gray-700">"What battery chemistry is best for my application?"</p>
                  </div>
                  <div className="bg-blue-50 p-4 rounded-lg">
                    <h4 className="font-bold text-blue-900 mb-2">üí∞ Financial Guidance</h4>
                    <p className="text-gray-700">"How do I calculate ROI for peak shaving?"</p>
                  </div>
                  <div className="bg-purple-50 p-4 rounded-lg">
                    <h4 className="font-bold text-purple-900 mb-2">üìã Configuration Help</h4>
                    <p className="text-gray-700">"What size system do I need for my facility?"</p>
                  </div>
                  <div className="bg-amber-50 p-4 rounded-lg">
                    <h4 className="font-bold text-amber-900 mb-2">üå± Sustainability Tips</h4>
                    <p className="text-gray-700">"What incentives are available in my region?"</p>
                  </div>
                </div>
                <div className="mt-8 p-4 bg-gray-100 rounded-lg">
                  <p className="text-gray-600 text-sm">
                    üí° <strong>For now:</strong> Use the Smart Wizard for guided configuration or contact our experts directly.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
