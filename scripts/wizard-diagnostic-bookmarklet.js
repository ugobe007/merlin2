/**
 * ============================================================================
 * MERLIN WIZARD DIAGNOSTIC - BOOKMARKLET VERSION
 * ============================================================================
 * 
 * HOW TO USE:
 * 1. Copy the minified code below (starting with "javascript:")
 * 2. Create a new bookmark in your browser
 * 3. Edit the bookmark URL and paste the code
 * 4. When on the wizard page, click the bookmark to run diagnostics
 * 
 * OR use the one-liner version at the bottom of this file
 * 
 * ============================================================================
 */

// Minified version (for bookmarklet)
// Copy everything after "javascript:" below

javascript:(function(){'use strict';console.clear();console.log('%cüßô MERLIN WIZARD DIAGNOSTIC','font-size:20px;font-weight:bold;color:#8B5CF6;');function findWizardState(){if(window.__MERLIN_STATE__)return{state:window.__MERLIN_STATE__,method:'Global:__MERLIN_STATE__'};if(window.__wizardState__)return{state:window.__wizardState__,method:'Global:__wizardState__'};try{const s=localStorage.getItem('merlin-wizard-state');if(s){const p=JSON.parse(s);if(p&&(p.industry||p.zipCode||p.useCaseData))return{state:p,method:'localStorage'};}}catch(e){}const r=['main','[class*="wizard"]','[class*="Wizard"]','#root','#app','[data-reactroot]','[data-react-root]'];for(const sel of r){const el=document.querySelector(sel);if(!el)continue;const fk=Object.keys(el).find(k=>k.startsWith('__reactFiber$')||k.startsWith('__reactInternalInstance$')||k.startsWith('__reactContainer$')||k==='__reactFiber'||k==='__reactInternalInstance');if(fk){const s=t(el[fk],0);if(s)return{state:s,method:`Fiber:${fk}`};}}return null;function t(f,d){if(!f||d>150)return null;let h=f.memoizedState;while(h){const s=h.memoizedState;if(s&&typeof s==='object'&&!Array.isArray(s)){if(i(s))return s;}if(h.queue){const q=h.queue.baseState||h.queue.memoizedState;if(q&&typeof q==='object'&&!Array.isArray(q)){if(i(q))return q;}}h=h.next;}if(f.stateNode){const n=f.stateNode;if(n.state&&typeof n.state==='object'){if(i(n.state))return n.state;}if(n.props&&typeof n.props==='object'){if(i(n.props))return n.props;}}if(f.memoizedProps&&typeof f.memoizedProps==='object'){if(i(f.memoizedProps))return f.memoizedProps;}if(f.alternate){const a=t(f.alternate,d+1);if(a)return a;}const c=[];if(f.child)c.push(f.child);if(f.sibling)c.push(f.sibling);if(f.return)c.push(f.return);for(const ch of c){const r=t(ch,d+1);if(r)return r;}return null;}function i(o){if(!o||typeof o!=='object'||Array.isArray(o))return false;const hi='industry'in o;const hz='zipCode'in o;const hf='facilityDetails'in o;const hu='useCaseData'in o;const hc='calculations'in o;const hp='selectedPowerLevel'in o;const m=[hi,hz,hf,hu,hc,hp].filter(Boolean).length;return m>=2;}}function runDiagnostic(s){const r={step1:{status:'‚ùì',issues:[],warnings:[]},step2:{status:'‚ùì',issues:[],warnings:[]},step3:{status:'‚ùì',issues:[],warnings:[]},step4:{status:'‚ùì',issues:[],warnings:[]},step5:{status:'‚ùì',issues:[],warnings:[]},calculations:{status:'‚ùì',issues:[],warnings:[]},storage:{status:'‚ùì',issues:[],warnings:[]},dataIntegrity:{status:'‚ùì',issues:[],warnings:[]}};if(s.zipCode&&s.zipCode.length>=5){if(s.state&&s.city){r.step1.status='‚úÖ';}else{r.step1.status='‚ö†Ô∏è';if(!s.state)r.step1.warnings.push('State not set');if(!s.city)r.step1.warnings.push('City not set');}}else{r.step1.status='‚ùå';if(!s.zipCode||s.zipCode.length<5)r.step1.issues.push('Missing ZIP code');}if(!s.goals||s.goals.length===0){r.step1.status=r.step1.status==='‚ùå'?'‚ùå':'‚ö†Ô∏è';(r.step1.status==='‚ùå'?r.step1.issues:r.step1.warnings).push('No goals selected');}if(s.industry&&s.industry!==''){if(s.industryName&&s.industryName!==''){r.step2.status='‚úÖ';}else{r.step2.status='‚ö†Ô∏è';r.step2.warnings.push('Industry name not set');}}else{r.step2.status='‚ùå';r.step2.issues.push('No industry selected');}const fd=Object.keys(s.facilityDetails||{}).filter(k=>{const v=s.facilityDetails[k];return v!==undefined&&v!==null&&v!==0&&v!=='';});const uc=Object.keys(s.useCaseData||{});const uv=Object.values(s.useCaseData||{}).filter(v=>v!==undefined&&v!==null&&v!==0&&v!==''&&(!Array.isArray(v)||v.length>0));if(uc.length>0||fd.length>2){if(uv.length===uc.length){r.step3.status='‚úÖ';}else{r.step3.status='‚ö†Ô∏è';r.step3.warnings.push(`${uc.length-uv.length} empty values`);}}else{r.step3.status='‚ùå';r.step3.issues.push('No facility data');if(uc.length===0)r.step3.issues.push('useCaseData is EMPTY');}const ad={...s.facilityDetails,...s.useCaseData};if(!ad.estimatedAnnualKwh||ad.estimatedAnnualKwh===0){if(r.step3.status==='‚úÖ')r.step3.status='‚ö†Ô∏è';r.step3.warnings.push('estimatedAnnualKwh missing or zero');}if(s.selectedOptions&&s.selectedOptions.length>0){r.step4.status='‚úÖ';}else{r.step4.status='‚ö†Ô∏è';r.step4.warnings.push('No options selected');}if(s.selectedPowerLevel){r.step5.status='‚úÖ';}else{r.step5.status='‚ö†Ô∏è';r.step5.warnings.push('No power level selected');}if(s.calculations){const c=s.calculations;if(c.bessKW>0&&c.bessKWh>0){r.calculations.status='‚úÖ';}else{r.calculations.status='‚ùå';if(c.bessKW===0)r.calculations.issues.push('BESS Power=0');if(c.bessKWh===0)r.calculations.issues.push('BESS Energy=0');}}else{r.calculations.status='‚ùå';r.calculations.issues.push('No calculations');}try{const st=localStorage.getItem('merlin-wizard-state');if(st){r.storage.status='‚úÖ';}else{r.storage.status='‚ö†Ô∏è';r.storage.warnings.push('Not in localStorage');}}catch(e){r.storage.status='‚ùå';r.storage.issues.push(e.message);}try{JSON.stringify(s);r.dataIntegrity.status='‚úÖ';}catch(e){r.dataIntegrity.status='‚ùå';r.dataIntegrity.issues.push('Circular reference');}return r;}function printResults(s,r,m){console.log('\n%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ','color:#8B5CF6;');console.log('%c DATA FLOW CHECK','font-size:14px;font-weight:bold;');console.log('%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ','color:#8B5CF6;');console.log(`%cState found via: ${m}`,'color:#9CA3AF;font-size:11px;');const steps=[{name:'Step 1:Location',key:'step1'},{name:'Step 2:Industry',key:'step2'},{name:'Step 3:Details',key:'step3'},{name:'Step 4:Options',key:'step4'},{name:'Step 5:System',key:'step5'},{name:'Calculations',key:'calculations'},{name:'Storage',key:'storage'},{name:'Data Integrity',key:'dataIntegrity'}];steps.forEach(st=>{const res=r[st.key];console.log(`\n${res.status} ${st.name}`);if(res.issues.length>0)res.issues.forEach(i=>console.log(`   %c‚ùå ${i}`,'color:#EF4444;'));if(res.warnings.length>0)res.warnings.forEach(w=>console.log(`   %c‚ö†Ô∏è  ${w}`,'color:#F59E0B;'));});const calc=s.calculations||{};const dur=calc.bessKW>0?(calc.bessKWh/calc.bessKW).toFixed(2):'N/A';console.log('\n%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ','color:#8B5CF6;');console.log('%cüîã BESS ANALYSIS','font-size:14px;font-weight:bold;');console.log('%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ','color:#8B5CF6;');console.log(`\n   BESS Power:  ${calc.bessKW||0} kW ${calc.bessKW===0?'‚Üê ‚ùå':''}`);console.log(`   BESS Energy: ${calc.bessKWh||0} kWh ${calc.bessKWh===0?'‚Üê ‚ùå':''}`);console.log(`   Duration:    ${dur} hours`);console.log(`   Investment:  $${(calc.totalInvestment||0).toLocaleString()}`);console.log(`   Savings:     $${(calc.annualSavings||0).toLocaleString()}/yr`);const ci=Object.entries(r).filter(([_,res])=>res.status==='‚ùå').map(([k,res])=>({step:k,issues:res.issues}));if(ci.length===0){console.log('\n   %c‚úÖ All critical checks passed!','color:#10B981;font-weight:bold;');}else{console.log(`\n   %c‚ùå ${ci.length} critical issue(s):`,'color:#EF4444;font-weight:bold;');ci.forEach(({step,issues})=>{issues.forEach(i=>console.log(`      ‚Ä¢ [${step}] ${i}`));});}window.__MERLIN_DEBUG_STATE__=s;window.__MERLIN_DEBUG_RESULTS__=r;console.log('\n   %cüíæ State saved to window.__MERLIN_DEBUG_STATE__','color:#9CA3AF;');console.log('   %cüì• Run exportDiagnosticJSON() to download results','color:#3B82F6;font-weight:bold;');}window.exportDiagnosticJSON=function(){const s=window.__MERLIN_DEBUG_STATE__;const r=window.__MERLIN_DEBUG_RESULTS__;if(!s||!r){console.error('No diagnostic data found');return;}const ed={timestamp:new Date().toISOString(),url:window.location.href,state:s,results:r,summary:{criticalIssues:Object.entries(r).filter(([_,res])=>res.status==='‚ùå').map(([k,res])=>({step:k,issues:res.issues})),overallStatus:Object.values(r).every(res=>res.status==='‚úÖ')?'PASS':Object.values(r).some(res=>res.status==='‚ùå')?'FAIL':'WARN'}};const json=JSON.stringify(ed,null,2);const blob=new Blob([json],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`merlin-diagnostic-${new Date().toISOString().split('T')[0]}-${Date.now()}.json`;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);console.log('%c‚úÖ Diagnostic data exported!','color:#10B981;font-weight:bold;');};const found=findWizardState();if(!found||!found.state){console.log('%c\n‚ùå Could not find wizard state!','color:#EF4444;font-weight:bold;');console.log('   Try: Navigate to Step 5 or 6, refresh, or use React DevTools');return;}console.log(`%c‚úÖ Found via: ${found.method}`,'color:#10B981;');const results=runDiagnostic(found.state);printResults(found.state,results,found.method);})();
